<!doctype html><html lang=zh-CN><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=UTF-8><meta name=generator content="Hugo 0.121.2"><meta name=theme-color content="#fff"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><title>TCP_IPç½‘ç»œç¼–ç¨‹2 | æ‚ é—²ã®å°å±‹</title>
<link rel=stylesheet href=/css/meme.min.css><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js defer></script><script src=/js/meme.min.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&amp;family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Cinzel+Decorative:wght@700&amp;display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&amp;family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Cinzel+Decorative:wght@700&amp;display=swap"></noscript><meta name=author content="Rurouni"><meta name=description content="è¿›ç¨‹é—´é€šä¿¡ è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡ å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†å®Œæˆè¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦åˆ›â€¦â€¦"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="æ‚ é—²ã®å°å±‹"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="æ‚ é—²ã®å°å±‹"><meta name=msapplication-starturl content="../../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://keepjolly.com/posts/learn/tcp_ip_network_programming2/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2023-08-13T22:41:59+08:00","dateModified":"2024-01-13T13:59:11+00:00","url":"https://keepjolly.com/posts/learn/tcp_ip_network_programming2/","headline":"TCP_IPç½‘ç»œç¼–ç¨‹2","description":"è¿›ç¨‹é—´é€šä¿¡ è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡ å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†å®Œæˆè¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦åˆ›â€¦â€¦","inLanguage":"zh-CN","articleSection":"posts","wordCount":16258,"image":["https://pic.keepjolly.com/halo/blog/2023/08/20230813224506.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-1.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://cdn.nlark.com/yuque/0/2023/png/12600461/1686926856566-2572cdd9-7a1e-4f1b-b49f-1610e73b306f.png#averageHue=%23ebebeb\u0026amp;clientId=u146b6ba8-d8f8-4\u0026amp;from=paste\u0026amp;id=u7a0be122\u0026amp;originHeight=279\u0026amp;originWidth=477\u0026amp;originalType=url\u0026amp;ratio=1.25\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;taskId=u0175482d-e892-498a-bc22-3038832ba0d\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-2.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-3.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-4.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-5.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-6.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-7.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-8.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-9.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=FciD5\u0026amp;originHeight=319\u0026amp;originWidth=540\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-10.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-11.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://cdn.nlark.com/yuque/0/2023/png/12600461/1689249181825-0c3d1dcb-c148-4a37-895c-3847e35814bf.png#averageHue=%23d5d5d5\u0026amp;clientId=ud362a5e0-75d0-4\u0026amp;from=paste\u0026amp;height=165\u0026amp;id=u340713e9\u0026amp;originHeight=198\u0026amp;originWidth=470\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;size=70970\u0026amp;status=done\u0026amp;style=none\u0026amp;taskId=udc8d66f8-5e2c-407e-a380-e88a9cae3d2\u0026amp;title=\u0026amp;width=391.6666666666667","https://cdn.nlark.com/yuque/0/2023/png/12600461/1689249194614-bbc5b267-3632-412f-8403-8be5fd246c3d.png#averageHue=%23d6d6d6\u0026amp;clientId=ud362a5e0-75d0-4\u0026amp;from=paste\u0026amp;height=174\u0026amp;id=ubec88290\u0026amp;originHeight=209\u0026amp;originWidth=463\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;size=80887\u0026amp;status=done\u0026amp;style=none\u0026amp;taskId=u58c328a6-bafc-40a1-b08b-011ea96fef9\u0026amp;title=\u0026amp;width=385.83333333333337","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-12.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-13.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-14.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=WmjF3\u0026amp;originHeight=303\u0026amp;originWidth=377\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-15.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=fc3E9\u0026amp;originHeight=270\u0026amp;originWidth=404\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-16.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=YP0bE\u0026amp;originHeight=327\u0026amp;originWidth=311\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-17.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=ZsCJA\u0026amp;originHeight=223\u0026amp;originWidth=343\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-18.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-19.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-20.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-21.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=XcoFX\u0026amp;originHeight=374\u0026amp;originWidth=309\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-22.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=CMVff\u0026amp;originHeight=292\u0026amp;originWidth=391\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-23.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url\u0026amp;id=uKMdm\u0026amp;originHeight=287\u0026amp;originWidth=387\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title="],"author":{"@type":"Person","description":"çŸ¥è¡Œåˆä¸€","email":"1366475809@qq.com","url":"https://keepjolly.com/","name":"Rurouni"},"license":"åœ¨ä¿ç•™æœ¬æ–‡ä½œè€…åŠæœ¬æ–‡é“¾æ¥çš„å‰æä¸‹ï¼Œéå•†ä¸šç”¨é€”éšæ„è½¬è½½åˆ†äº«(æˆ‘ä¼šé«˜å¼ºåº¦è‡ªæœçš„å–”ğŸ‘Š)ã€‚","publisher":{"@type":"Organization","name":"æ‚ é—²ã®å°å±‹","url":"https://keepjolly.com/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://keepjolly.com/"}}</script><meta name=twitter:card content="summary_large_image"><meta property="og:title" content="TCP_IPç½‘ç»œç¼–ç¨‹2"><meta property="og:description" content="è¿›ç¨‹é—´é€šä¿¡ è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡ å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†å®Œæˆè¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦åˆ›â€¦â€¦"><meta property="og:url" content="https://keepjolly.com/posts/learn/tcp_ip_network_programming2/"><meta property="og:site_name" content="æ‚ é—²ã®å°å±‹"><meta property="og:locale" content="zh"><meta property="og:image" content="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5"><meta property="og:type" content="article"><meta property="article:published_time" content="2023-08-13T22:41:59+08:00"><meta property="article:modified_time" content="2024-01-13T13:59:11+00:00"><meta property="article:section" content="posts"><meta name=google-site-verification content="mBjLYgXaXR8EAfTNbi4DTVC5KOJuBHpZDsmtgbgC6Rs"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>æ‚ é—²ã®å°å±‹</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/categories/><span class=menu-item-name>åˆ†ç±»</span></a></li><li class=menu-item><a href=/tags/><span class=menu-item-name>æ ‡ç­¾</span></a></li><li class=menu-item><a href=/about/><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li><li class="menu-item search-item"><form id=search class=search role=search><label for=search-input><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label><input type=search id=search-input class=search-input></form><template id=search-result hidden><article class="content post"><h2 class=post-title><a class=summary-title-link></a></h2><summary class=summary></summary><div class=read-more-container><a class=read-more-link>é˜…è¯»æ›´å¤š Â»</a></div></article></template></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><div class=toc-wrapper><div class=post-toc id=post-toc><aside><header><h4>æ–‡ç« ã®å­—æ•°: 16258</h4></header><nav id=TableOfContents><ol><li><a href=#è¿›ç¨‹é—´é€šä¿¡>è¿›ç¨‹é—´é€šä¿¡</a><ol><li><a href=#è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ>è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ</a><ol><li><a href=#ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡>ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡</a></li><li><a href=#å•å‘é€šä¿¡>å•å‘é€šä¿¡</a></li><li><a href=#åŒå‘é€šä¿¡>åŒå‘é€šä¿¡</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></li></ol></li><li><a href=#io-å¤ç”¨>I/O å¤ç”¨</a><ol><li><a href=#åŸºäº-io-å¤ç”¨çš„æœåŠ¡å™¨ç«¯>åŸºäº I/O å¤ç”¨çš„æœåŠ¡å™¨ç«¯</a></li><li><a href=#ç†è§£-select-å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯>ç†è§£ select å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯</a></li><li><a href=#è®¾ç½®æ–‡ä»¶æè¿°ç¬¦>è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</a><ol><li><a href=#è®¾ç½®æ£€æŸ¥ç›‘è§†èŒƒå›´åŠè¶…æ—¶>è®¾ç½®æ£€æŸ¥ï¼ˆç›‘è§†ï¼‰èŒƒå›´åŠè¶…æ—¶</a></li></ol></li></ol></li><li><a href=#å¤šç§-io-å‡½æ•°>å¤šç§ I/O å‡½æ•°</a><ol><li><a href=#send--recv-å‡½æ•°>send & recv å‡½æ•°</a><ol><li><a href=#msg_oobå‘é€ç´§æ€¥æ¶ˆæ¯>MSG_OOBï¼šå‘é€ç´§æ€¥æ¶ˆæ¯</a></li><li><a href=#æ£€æŸ¥è¾“å…¥ç¼“å†²>æ£€æŸ¥è¾“å…¥ç¼“å†²</a></li></ol></li><li><a href=#readv--writev-å‡½æ•°>readv & writev å‡½æ•°</a><ol><li><a href=#writev-å‡½æ•°>writev å‡½æ•°</a></li><li><a href=#readv-å‡½æ•°>readv å‡½æ•°</a></li><li><a href=#åˆç†ä½¿ç”¨-readv--writev-å‡½æ•°>åˆç†ä½¿ç”¨ readv & writev å‡½æ•°</a></li></ol></li></ol></li><li><a href=#å¤šæ’­ä¸å¹¿æ’­>å¤šæ’­ä¸å¹¿æ’­</a><ol><li><a href=#å¤šæ’­>å¤šæ’­</a><ol><li><a href=#å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹>å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹</a></li><li><a href=#è·¯ç”±routingå’Œ-ttltime-to-liveç”Ÿå­˜æ—¶é—´ä»¥åŠåŠ å…¥ç»„çš„åŠæ³•>è·¯ç”±ï¼ˆRoutingï¼‰å’Œ TTLï¼ˆTime to Live,ç”Ÿå­˜æ—¶é—´ï¼‰ï¼Œä»¥åŠåŠ å…¥ç»„çš„åŠæ³•</a></li><li><a href=#å®ç°å¤šæ’­-sender-å’Œ-receiver>å®ç°å¤šæ’­ Sender å’Œ Receiver</a></li></ol></li><li><a href=#å¹¿æ’­>å¹¿æ’­</a><ol><li><a href=#å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼>å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼</a></li></ol></li></ol></li><li><a href=#å¥—æ¥å­—å’Œæ ‡å‡†io>å¥—æ¥å­—å’Œæ ‡å‡†I/O</a><ol><li><a href=#æ ‡å‡†-io-çš„ä¼˜ç¼ºç‚¹>æ ‡å‡† I/O çš„ä¼˜ç¼ºç‚¹</a></li><li><a href=#ä½¿ç”¨æ ‡å‡†-io-å‡½æ•°>ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°</a><ol><li><a href=#åˆ©ç”¨-fdopen-å‡½æ•°è½¬æ¢ä¸º-file-ç»“æ„ä½“æŒ‡é’ˆ>åˆ©ç”¨ fdopen å‡½æ•°è½¬æ¢ä¸º FILE ç»“æ„ä½“æŒ‡é’ˆ</a></li><li><a href=#åˆ©ç”¨-fileno-å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦>åˆ©ç”¨ fileno å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦</a></li></ol></li><li><a href=#åŸºäºå¥—æ¥å­—çš„æ ‡å‡†-io-å‡½æ•°ä½¿ç”¨>åŸºäºå¥—æ¥å­—çš„æ ‡å‡† I/O å‡½æ•°ä½¿ç”¨</a></li></ol></li><li><a href=#io-æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹>I/O æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹</a><ol><li><ol><li><a href=#åˆ†ç¦»æµçš„å¥½å¤„>åˆ†ç¦»ã€Œæµã€çš„å¥½å¤„</a></li><li><a href=#æµåˆ†ç¦»å¸¦æ¥çš„-eof-é—®é¢˜>ã€Œæµã€åˆ†ç¦»å¸¦æ¥çš„ EOF é—®é¢˜</a><ol><li><a href=#æµçš„åˆ†ç¦»>æµçš„åˆ†ç¦»</a></li></ol></li></ol></li></ol></li><li><a href=#ä¼˜äº-select-çš„-epoll>ä¼˜äº select çš„ epoll</a><ol><li><a href=#epoll-ç†è§£åŠåº”ç”¨>epoll ç†è§£åŠåº”ç”¨</a><ol><li><a href=#åŸºäº-select-çš„-io-å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› >åŸºäº select çš„ I/O å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› </a></li><li><a href=#select-ä¼˜ç‚¹>select ä¼˜ç‚¹</a></li><li><a href=#å®ç°-epoll-æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“>å®ç° epoll æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“</a></li><li><a href=#epoll_create>epoll_create</a></li><li><a href=#epoll_ctl>epoll_ctl</a></li><li><a href=#epoll_wait>epoll_wait</a></li><li><a href=#åŸºäº-epoll-çš„å›å£°æœåŠ¡å™¨ç«¯>åŸºäº epoll çš„å›å£°æœåŠ¡å™¨ç«¯</a></li></ol></li><li><a href=#æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘>æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘</a><ol><li><a href=#è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹>è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹</a></li><li><a href=#æ”¹å˜æ–‡ä»¶å±æ€§>æ”¹å˜æ–‡ä»¶å±æ€§</a></li><li><a href=#å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯>å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯</a></li><li><a href=#æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£>æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£</a></li></ol></li></ol></li><li><a href=#å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°>å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°</a><ol><li><a href=#ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ>ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ</a><ol><li><a href=#çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚>çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚</a></li></ol></li><li><a href=#çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ>çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ</a><ol><li><a href=#posixçš„ç”±æ¥>posixçš„ç”±æ¥</a></li><li><a href=#çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹>çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹</a></li><li><a href=#å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°>å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°</a></li><li><a href=#å·¥ä½œworkerçº¿ç¨‹æ¨¡å‹>å·¥ä½œï¼ˆWorkerï¼‰çº¿ç¨‹æ¨¡å‹</a></li></ol></li><li><a href=#çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº>çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº</a><ol><li><a href=#ä¸´ç•ŒåŒºä½ç½®>ä¸´ç•ŒåŒºä½ç½®</a></li></ol></li><li><a href=#çº¿ç¨‹åŒæ­¥>çº¿ç¨‹åŒæ­¥</a><ol><li><a href=#äº’æ–¥é‡>äº’æ–¥é‡</a></li><li><a href=#ä¿¡å·é‡>ä¿¡å·é‡</a></li></ol></li><li><a href=#çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°>çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</a><ol><li><a href=#é”€æ¯çº¿ç¨‹çš„-3-ç§æ–¹æ³•>é”€æ¯çº¿ç¨‹çš„ 3 ç§æ–¹æ³•</a></li><li><a href=#å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°>å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</a></li></ol></li></ol></li><li><a href=#åˆ¶ä½œ-http-æœåŠ¡å™¨ç«¯>åˆ¶ä½œ HTTP æœåŠ¡å™¨ç«¯</a><ol><li><a href=#http-æ¦‚è¦>HTTP æ¦‚è¦</a><ol><li><a href=#ç†è§£-web-æœåŠ¡å™¨ç«¯>ç†è§£ Web æœåŠ¡å™¨ç«¯</a></li><li><a href=#http>HTTP</a></li><li><a href=#è¯·æ±‚æ¶ˆæ¯request-messageçš„ç»“æ„>è¯·æ±‚æ¶ˆæ¯ï¼ˆRequest Messageï¼‰çš„ç»“æ„</a></li><li><a href=#2414-å“åº”æ¶ˆæ¯response-messageçš„ç»“æ„>24.1.4 å“åº”æ¶ˆæ¯ï¼ˆResponse Messageï¼‰çš„ç»“æ„</a></li></ol></li></ol></li></ol></nav></aside><a href=# id=toc-toggle></a></div><div class=toc-phone><nav class=contents><h2 id=contents class=contents-title>ç›®å½•</h2><ol class=toc><li><a id=contents:è¿›ç¨‹é—´é€šä¿¡ href=#è¿›ç¨‹é—´é€šä¿¡>è¿›ç¨‹é—´é€šä¿¡</a><ol><li><a id=contents:è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ href=#è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ>è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ</a><ol><li><a id=contents:ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡ href=#ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡>ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡</a></li><li><a id=contents:å•å‘é€šä¿¡ href=#å•å‘é€šä¿¡>å•å‘é€šä¿¡</a></li><li><a id=contents:åŒå‘é€šä¿¡ href=#åŒå‘é€šä¿¡>åŒå‘é€šä¿¡</a></li><li><a id=contents:æ€»ç»“ href=#æ€»ç»“>æ€»ç»“</a></li></ol></li></ol></li><li><a id=contents:io-å¤ç”¨ href=#io-å¤ç”¨>I/O å¤ç”¨</a><ol><li><a id=contents:åŸºäº-io-å¤ç”¨çš„æœåŠ¡å™¨ç«¯ href=#åŸºäº-io-å¤ç”¨çš„æœåŠ¡å™¨ç«¯>åŸºäº I/O å¤ç”¨çš„æœåŠ¡å™¨ç«¯</a></li><li><a id=contents:ç†è§£-select-å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯ href=#ç†è§£-select-å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯>ç†è§£ select å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯</a></li><li><a id=contents:è®¾ç½®æ–‡ä»¶æè¿°ç¬¦ href=#è®¾ç½®æ–‡ä»¶æè¿°ç¬¦>è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</a><ol><li><a id=contents:è®¾ç½®æ£€æŸ¥ç›‘è§†èŒƒå›´åŠè¶…æ—¶ href=#è®¾ç½®æ£€æŸ¥ç›‘è§†èŒƒå›´åŠè¶…æ—¶>è®¾ç½®æ£€æŸ¥ï¼ˆç›‘è§†ï¼‰èŒƒå›´åŠè¶…æ—¶</a></li></ol></li></ol></li><li><a id=contents:å¤šç§-io-å‡½æ•° href=#å¤šç§-io-å‡½æ•°>å¤šç§ I/O å‡½æ•°</a><ol><li><a id=contents:send--recv-å‡½æ•° href=#send--recv-å‡½æ•°>send & recv å‡½æ•°</a><ol><li><a id=contents:msg_oobå‘é€ç´§æ€¥æ¶ˆæ¯ href=#msg_oobå‘é€ç´§æ€¥æ¶ˆæ¯>MSG_OOBï¼šå‘é€ç´§æ€¥æ¶ˆæ¯</a></li><li><a id=contents:æ£€æŸ¥è¾“å…¥ç¼“å†² href=#æ£€æŸ¥è¾“å…¥ç¼“å†²>æ£€æŸ¥è¾“å…¥ç¼“å†²</a></li></ol></li><li><a id=contents:readv--writev-å‡½æ•° href=#readv--writev-å‡½æ•°>readv & writev å‡½æ•°</a><ol><li><a id=contents:writev-å‡½æ•° href=#writev-å‡½æ•°>writev å‡½æ•°</a></li><li><a id=contents:readv-å‡½æ•° href=#readv-å‡½æ•°>readv å‡½æ•°</a></li><li><a id=contents:åˆç†ä½¿ç”¨-readv--writev-å‡½æ•° href=#åˆç†ä½¿ç”¨-readv--writev-å‡½æ•°>åˆç†ä½¿ç”¨ readv & writev å‡½æ•°</a></li></ol></li></ol></li><li><a id=contents:å¤šæ’­ä¸å¹¿æ’­ href=#å¤šæ’­ä¸å¹¿æ’­>å¤šæ’­ä¸å¹¿æ’­</a><ol><li><a id=contents:å¤šæ’­ href=#å¤šæ’­>å¤šæ’­</a><ol><li><a id=contents:å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹ href=#å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹>å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹</a></li><li><a id=contents:è·¯ç”±routingå’Œ-ttltime-to-liveç”Ÿå­˜æ—¶é—´ä»¥åŠåŠ å…¥ç»„çš„åŠæ³• href=#è·¯ç”±routingå’Œ-ttltime-to-liveç”Ÿå­˜æ—¶é—´ä»¥åŠåŠ å…¥ç»„çš„åŠæ³•>è·¯ç”±ï¼ˆRoutingï¼‰å’Œ TTLï¼ˆTime to Live,ç”Ÿå­˜æ—¶é—´ï¼‰ï¼Œä»¥åŠåŠ å…¥ç»„çš„åŠæ³•</a></li><li><a id=contents:å®ç°å¤šæ’­-sender-å’Œ-receiver href=#å®ç°å¤šæ’­-sender-å’Œ-receiver>å®ç°å¤šæ’­ Sender å’Œ Receiver</a></li></ol></li><li><a id=contents:å¹¿æ’­ href=#å¹¿æ’­>å¹¿æ’­</a><ol><li><a id=contents:å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼ href=#å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼>å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼</a></li></ol></li></ol></li><li><a id=contents:å¥—æ¥å­—å’Œæ ‡å‡†io href=#å¥—æ¥å­—å’Œæ ‡å‡†io>å¥—æ¥å­—å’Œæ ‡å‡†I/O</a><ol><li><a id=contents:æ ‡å‡†-io-çš„ä¼˜ç¼ºç‚¹ href=#æ ‡å‡†-io-çš„ä¼˜ç¼ºç‚¹>æ ‡å‡† I/O çš„ä¼˜ç¼ºç‚¹</a></li><li><a id=contents:ä½¿ç”¨æ ‡å‡†-io-å‡½æ•° href=#ä½¿ç”¨æ ‡å‡†-io-å‡½æ•°>ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°</a><ol><li><a id=contents:åˆ©ç”¨-fdopen-å‡½æ•°è½¬æ¢ä¸º-file-ç»“æ„ä½“æŒ‡é’ˆ href=#åˆ©ç”¨-fdopen-å‡½æ•°è½¬æ¢ä¸º-file-ç»“æ„ä½“æŒ‡é’ˆ>åˆ©ç”¨ fdopen å‡½æ•°è½¬æ¢ä¸º FILE ç»“æ„ä½“æŒ‡é’ˆ</a></li><li><a id=contents:åˆ©ç”¨-fileno-å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ href=#åˆ©ç”¨-fileno-å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦>åˆ©ç”¨ fileno å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦</a></li></ol></li><li><a id=contents:åŸºäºå¥—æ¥å­—çš„æ ‡å‡†-io-å‡½æ•°ä½¿ç”¨ href=#åŸºäºå¥—æ¥å­—çš„æ ‡å‡†-io-å‡½æ•°ä½¿ç”¨>åŸºäºå¥—æ¥å­—çš„æ ‡å‡† I/O å‡½æ•°ä½¿ç”¨</a></li></ol></li><li><a id=contents:io-æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹ href=#io-æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹>I/O æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹</a><ol><li><ol><li><a id=contents:åˆ†ç¦»æµçš„å¥½å¤„ href=#åˆ†ç¦»æµçš„å¥½å¤„>åˆ†ç¦»ã€Œæµã€çš„å¥½å¤„</a></li><li><a id=contents:æµåˆ†ç¦»å¸¦æ¥çš„-eof-é—®é¢˜ href=#æµåˆ†ç¦»å¸¦æ¥çš„-eof-é—®é¢˜>ã€Œæµã€åˆ†ç¦»å¸¦æ¥çš„ EOF é—®é¢˜</a><ol><li><a id=contents:æµçš„åˆ†ç¦» href=#æµçš„åˆ†ç¦»>æµçš„åˆ†ç¦»</a></li></ol></li></ol></li></ol></li><li><a id=contents:ä¼˜äº-select-çš„-epoll href=#ä¼˜äº-select-çš„-epoll>ä¼˜äº select çš„ epoll</a><ol><li><a id=contents:epoll-ç†è§£åŠåº”ç”¨ href=#epoll-ç†è§£åŠåº”ç”¨>epoll ç†è§£åŠåº”ç”¨</a><ol><li><a id=contents:åŸºäº-select-çš„-io-å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå›  href=#åŸºäº-select-çš„-io-å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› >åŸºäº select çš„ I/O å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› </a></li><li><a id=contents:select-ä¼˜ç‚¹ href=#select-ä¼˜ç‚¹>select ä¼˜ç‚¹</a></li><li><a id=contents:å®ç°-epoll-æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“ href=#å®ç°-epoll-æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“>å®ç° epoll æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“</a></li><li><a id=contents:epoll_create href=#epoll_create>epoll_create</a></li><li><a id=contents:epoll_ctl href=#epoll_ctl>epoll_ctl</a></li><li><a id=contents:epoll_wait href=#epoll_wait>epoll_wait</a></li><li><a id=contents:åŸºäº-epoll-çš„å›å£°æœåŠ¡å™¨ç«¯ href=#åŸºäº-epoll-çš„å›å£°æœåŠ¡å™¨ç«¯>åŸºäº epoll çš„å›å£°æœåŠ¡å™¨ç«¯</a></li></ol></li><li><a id=contents:æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ href=#æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘>æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘</a><ol><li><a id=contents:è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹ href=#è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹>è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹</a></li><li><a id=contents:æ”¹å˜æ–‡ä»¶å±æ€§ href=#æ”¹å˜æ–‡ä»¶å±æ€§>æ”¹å˜æ–‡ä»¶å±æ€§</a></li><li><a id=contents:å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯ href=#å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯>å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯</a></li><li><a id=contents:æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£ href=#æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£>æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£</a></li></ol></li></ol></li><li><a id=contents:å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç° href=#å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°>å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°</a><ol><li><a id=contents:ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ href=#ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ>ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ</a><ol><li><a id=contents:çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚ href=#çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚>çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚</a></li></ol></li><li><a id=contents:çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ href=#çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ>çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ</a><ol><li><a id=contents:posixçš„ç”±æ¥ href=#posixçš„ç”±æ¥>posixçš„ç”±æ¥</a></li><li><a id=contents:çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹ href=#çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹>çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹</a></li><li><a id=contents:å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•° href=#å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°>å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°</a></li><li><a id=contents:å·¥ä½œworkerçº¿ç¨‹æ¨¡å‹ href=#å·¥ä½œworkerçº¿ç¨‹æ¨¡å‹>å·¥ä½œï¼ˆWorkerï¼‰çº¿ç¨‹æ¨¡å‹</a></li></ol></li><li><a id=contents:çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº href=#çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº>çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº</a><ol><li><a id=contents:ä¸´ç•ŒåŒºä½ç½® href=#ä¸´ç•ŒåŒºä½ç½®>ä¸´ç•ŒåŒºä½ç½®</a></li></ol></li><li><a id=contents:çº¿ç¨‹åŒæ­¥ href=#çº¿ç¨‹åŒæ­¥>çº¿ç¨‹åŒæ­¥</a><ol><li><a id=contents:äº’æ–¥é‡ href=#äº’æ–¥é‡>äº’æ–¥é‡</a></li><li><a id=contents:ä¿¡å·é‡ href=#ä¿¡å·é‡>ä¿¡å·é‡</a></li></ol></li><li><a id=contents:çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç° href=#çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°>çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</a><ol><li><a id=contents:é”€æ¯çº¿ç¨‹çš„-3-ç§æ–¹æ³• href=#é”€æ¯çº¿ç¨‹çš„-3-ç§æ–¹æ³•>é”€æ¯çº¿ç¨‹çš„ 3 ç§æ–¹æ³•</a></li><li><a id=contents:å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç° href=#å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°>å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</a></li></ol></li></ol></li><li><a id=contents:åˆ¶ä½œ-http-æœåŠ¡å™¨ç«¯ href=#åˆ¶ä½œ-http-æœåŠ¡å™¨ç«¯>åˆ¶ä½œ HTTP æœåŠ¡å™¨ç«¯</a><ol><li><a id=contents:http-æ¦‚è¦ href=#http-æ¦‚è¦>HTTP æ¦‚è¦</a><ol><li><a id=contents:ç†è§£-web-æœåŠ¡å™¨ç«¯ href=#ç†è§£-web-æœåŠ¡å™¨ç«¯>ç†è§£ Web æœåŠ¡å™¨ç«¯</a></li><li><a id=contents:http href=#http>HTTP</a></li><li><a id=contents:è¯·æ±‚æ¶ˆæ¯request-messageçš„ç»“æ„ href=#è¯·æ±‚æ¶ˆæ¯request-messageçš„ç»“æ„>è¯·æ±‚æ¶ˆæ¯ï¼ˆRequest Messageï¼‰çš„ç»“æ„</a></li><li><a id=contents:2414-å“åº”æ¶ˆæ¯response-messageçš„ç»“æ„ href=#2414-å“åº”æ¶ˆæ¯response-messageçš„ç»“æ„>24.1.4 å“åº”æ¶ˆæ¯ï¼ˆResponse Messageï¼‰çš„ç»“æ„</a></li></ol></li></ol></li></ol></nav><hr></hr></div></div><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=posts data-toc-num=true><h1 class="post-title p-name">TCP_IPç½‘ç»œç¼–ç¨‹2</h1><div class="post-body e-content"><h2 id=è¿›ç¨‹é—´é€šä¿¡><a href=#è¿›ç¨‹é—´é€šä¿¡ class=anchor-link>#</a>è¿›ç¨‹é—´é€šä¿¡</h2><h3 id=è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ><a href=#è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ class=anchor-link>#</a>è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ</h3><h4 id=ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡><a href=#ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡ class=anchor-link>#</a>ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡</h4><p><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt><br>å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†å®Œæˆè¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦åˆ›å»ºç®¡é“ã€‚ç®¡é“å¹¶éå±äºè¿›ç¨‹çš„èµ„æºï¼Œè€Œæ˜¯å’Œå¥—æ¥å­—ä¸€æ ·ï¼Œå±äºæ“ä½œç³»ç»Ÿï¼ˆä¹Ÿå°±ä¸æ˜¯ fork å‡½æ•°çš„å¤åˆ¶å¯¹è±¡ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸¤ä¸ªè¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„å†…å­˜ç©ºé—´è¿›è¡Œé€šä¿¡ã€‚ä¸‹é¢æ˜¯åˆ›å»ºç®¡é“çš„å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>pipe</span><span class=p>(</span><span class=kt>int</span> <span class=n>filedes</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>filedes[0]: é€šè¿‡ç®¡é“æ¥æ”¶æ•°æ®æ—¶ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³ç®¡é“å‡ºå£
</span></span></span><span class=line><span class=cl><span class=cm>filedes[1]: é€šè¿‡ç®¡é“ä¼ è¾“æ•°æ®æ—¶ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³ç®¡é“å…¥å£
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=å•å‘é€šä¿¡><a href=#å•å‘é€šä¿¡ class=anchor-link>#</a>å•å‘é€šä¿¡</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// è°ƒç”¨  pipe å‡½æ•°åˆ›å»ºç®¡é“ï¼Œfds æ•°ç»„ä¸­ä¿å­˜ç”¨äº I/O çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pipe</span><span class=p>(</span><span class=n>fds</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span> <span class=c1>//å­è¿›ç¨‹å°†åŒæ—¶æ‹¥æœ‰åˆ›å»ºç®¡é“è·å–çš„2ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤åˆ¶çš„å¹¶éç®¡é“ï¼Œè€Œæ˜¯æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>write</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>str</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>read</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>buf</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-1.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt></p><h4 id=åŒå‘é€šä¿¡><a href=#åŒå‘é€šä¿¡ class=anchor-link>#</a>åŒå‘é€šä¿¡</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/12600461/1686926856566-2572cdd9-7a1e-4f1b-b49f-1610e73b306f.png#averageHue=%23ebebeb&amp;clientId=u146b6ba8-d8f8-4&amp;from=paste&amp;id=u7a0be122&amp;originHeight=279&amp;originWidth=477&amp;originalType=url&amp;ratio=1.25&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u0175482d-e892-498a-bc22-3038832ba0d&amp;title=" alt><br>ä¸Šè¿°å•ä¸ªpipeå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æ¥æ”¶é—®é¢˜ï¼Œå³å­è¿›ç¨‹æŠŠæ‰€æœ‰æ•°æ®éƒ½è¯»å®Œï¼Œéœ€è¦sleepå‡½æ•°ã€‚é‡‡ç”¨ä¸‹è¿°æ–¹æ³•å¥½ä¸€äº›ï¼Œä½†æ˜¯å¤šåŠ ä¸€ä¸ªpipe<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-2.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt></p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>pipe</span><span class=p>(</span><span class=n>fds1</span><span class=p>),</span> <span class=n>pipe</span><span class=p>(</span><span class=n>fds2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>fds1</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>str1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>read</span><span class=p>(</span><span class=n>fds2</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>buf</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Child proc output: %s </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>read</span><span class=p>(</span><span class=n>fds1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>buf</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Parent proc output: %s </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>fds2</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>str2</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=æ€»ç»“><a href=#æ€»ç»“ class=anchor-link>#</a>æ€»ç»“</h4><p>è¿›ç¨‹é—´é€šä¿¡æ„å‘³ç€ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹é—´å¯ä»¥äº¤æ¢æ•°æ®ã€‚ä»å†…å­˜ä¸Šæ¥è¯´ï¼Œå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œç„¶åé€šè¿‡è¿™ä¸ªå†…å­˜åŒºåŸŸæ•°æ®çš„å˜åŒ–æ¥è¿›è¡Œé€šä¿¡ã€‚</p><h2 id=io-å¤ç”¨><a href=#io-å¤ç”¨ class=anchor-link>#</a>I/O å¤ç”¨</h2><h3 id=åŸºäº-io-å¤ç”¨çš„æœåŠ¡å™¨ç«¯><a href=#åŸºäº-io-å¤ç”¨çš„æœåŠ¡å™¨ç«¯ class=anchor-link>#</a>åŸºäº I/O å¤ç”¨çš„æœåŠ¡å™¨ç«¯</h3><p>å¤šè¿›ç¨‹æœåŠ¡ç«¯çš„ç¼ºç‚¹ï¼šä¸ºäº†æ„å»ºå¹¶å‘æœåŠ¡å™¨ï¼Œåªè¦æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å°±ä¼šåˆ›å»ºæ–°è¿›ç¨‹ã€‚è¿™çš„ç¡®æ˜¯å®é™…æ“ä½œä¸­é‡‡ç”¨çš„ä¸€ç§æ–¹æ¡ˆï¼Œä½†å¹¶éåå…¨åç¾ï¼Œå› ä¸ºåˆ›å»ºè¿›ç¨‹è¦ä»˜å‡ºå¾ˆå¤§çš„ä»£ä»·ã€‚è¿™éœ€è¦å¤§é‡çš„è¿ç®—å’Œå†…å­˜ç©ºé—´ï¼Œç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½å…·æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥ç›¸äº’é—´çš„æ•°æ®äº¤æ¢ä¹Ÿè¦é‡‡ç”¨ç›¸å¯¹å¤æ‚çš„æ–¹æ³•ï¼ˆIPC å±äºç›¸å¯¹å¤æ‚çš„é€šä¿¡æ–¹æ³•ï¼‰ã€‚<br>I/O å¤ç”¨æŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-3.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png><br>æ— è®ºè¿æ¥å¤šå°‘å®¢æˆ·ç«¯ï¼Œæä¾›æœåŠ¡çš„è¿›ç¨‹åªæœ‰ä¸€ä¸ªã€‚</p><h3 id=ç†è§£-select-å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯><a href=#ç†è§£-select-å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯ class=anchor-link>#</a>ç†è§£ select å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯</h3><p>select å‡½æ•°æ˜¯æœ€å…·ä»£è¡¨æ€§çš„å®ç°å¤ç”¨æœåŠ¡å™¨çš„æ–¹æ³•ã€‚åœ¨ Windows å¹³å°ä¸‹ä¹Ÿæœ‰åŒåå‡½æ•°ï¼Œæ‰€ä»¥å…·æœ‰å¾ˆå¥½çš„ç§»æ¤æ€§ã€‚<br>select å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-4.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></p><h3 id=è®¾ç½®æ–‡ä»¶æè¿°ç¬¦><a href=#è®¾ç½®æ–‡ä»¶æè¿°ç¬¦ class=anchor-link>#</a>è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</h3><p>åˆ©ç”¨ select å‡½æ•°å¯ä»¥<strong>åŒæ—¶ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦</strong>ã€‚å½“ç„¶ï¼Œç›‘è§†æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è§†ä¸ºç›‘è§†å¥—æ¥å­—ã€‚æ­¤æ—¶é¦–å…ˆéœ€è¦å°†è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†ä¸­åœ¨ä¸€èµ·ã€‚é›†ä¸­æ—¶ä¹Ÿè¦æŒ‰ç…§ç›‘è§†é¡¹ï¼ˆ<strong>æ¥æ”¶ã€ä¼ è¾“ã€å¼‚å¸¸</strong>ï¼‰è¿›è¡ŒåŒºåˆ†ï¼Œå³æŒ‰ç…§ä¸Šè¿° 3 ç§ç›‘è§†é¡¹åˆ†æˆ 3 ç±»ã€‚<br>åˆ©ç”¨ fd_set æ•°ç»„å˜é‡æ‰§è¡Œæ­¤æ“ä½œï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè¯¥æ•°ç»„æ˜¯å­˜æœ‰0å’Œ1çš„ä½æ•°ç»„ã€‚<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-5.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png><br>å›¾ä¸­æœ€å·¦ç«¯è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ 0ã€‚å¦‚æœè¯¥ä½è®¾ç½®ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ˜¯ç›‘è§†å¯¹è±¡ã€‚å›¾ä¸­æ–‡ä»¶æè¿°ç¬¦ 1 å’Œ 3æ˜¯ç›‘è§†å¯¹è±¡ã€‚åœ¨ fd_set å˜é‡ä¸­æ³¨å†Œæˆ–æ›´æ”¹å€¼çš„æ“ä½œéƒ½ç”±ä¸‹åˆ—å®å®Œæˆã€‚</p><ul><li>FD_ZERO(fd_set *fdset)ï¼šå°† fd_set å˜é‡æ‰€æŒ‡çš„ä½å…¨éƒ¨åˆå§‹åŒ–æˆ0</li><li>FD_SET(int fd,fd_set *fdset)ï¼šåœ¨å‚æ•° fdset æŒ‡å‘çš„å˜é‡ä¸­æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ fd çš„ä¿¡æ¯</li><li>FD_CLR(int fd,fd_set *fdset)ï¼šä»å‚æ•° fdset æŒ‡å‘çš„å˜é‡ä¸­æ¸…é™¤æ–‡ä»¶æè¿°ç¬¦ fd çš„ä¿¡æ¯</li><li>FD_ISSET(int fd,fd_set *fdset)ï¼šè‹¥å‚æ•° fdset æŒ‡å‘çš„å˜é‡ä¸­åŒ…å«æ–‡ä»¶æè¿°ç¬¦ fd çš„ä¿¡æ¯ï¼Œåˆ™è¿”å›ã€ŒçœŸã€</li></ul><p><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-6.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></p><h4 id=è®¾ç½®æ£€æŸ¥ç›‘è§†èŒƒå›´åŠè¶…æ—¶><a href=#è®¾ç½®æ£€æŸ¥ç›‘è§†èŒƒå›´åŠè¶…æ—¶ class=anchor-link>#</a>è®¾ç½®æ£€æŸ¥ï¼ˆç›‘è§†ï¼‰èŒƒå›´åŠè¶…æ—¶</h4><p>ä¸‹é¢æ˜¯ select å‡½æ•°çš„å®šä¹‰ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/select.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>select</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxfd</span><span class=p>,</span> <span class=n>fd_set</span> <span class=o>*</span><span class=n>readset</span><span class=p>,</span> <span class=n>fd_set</span> <span class=o>*</span><span class=n>writeset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=n>fd_set</span> <span class=o>*</span><span class=n>exceptset</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=nc>timeval</span> <span class=o>*</span><span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›å¤§äº 0 çš„å€¼ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>maxfd: ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦æ•°é‡
</span></span></span><span class=line><span class=cl><span class=cm>readset: å°†æ‰€æœ‰å…³æ³¨ã€Œæ˜¯å¦å­˜åœ¨å¾…è¯»å–æ•°æ®ã€çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° fd_set å‹å˜é‡ï¼Œå¹¶ä¼ é€’å…¶åœ°å€å€¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>writeset: å°†æ‰€æœ‰å…³æ³¨ã€Œæ˜¯å¦å¯ä¼ è¾“æ— é˜»å¡æ•°æ®ã€çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° fd_set å‹å˜é‡ï¼Œå¹¶ä¼ é€’å…¶åœ°å€å€¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>exceptset: å°†æ‰€æœ‰å…³æ³¨ã€Œæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ã€çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° fd_set å‹å˜é‡ï¼Œå¹¶ä¼ é€’å…¶åœ°å€å€¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>timeout: è°ƒç”¨ select å‡½æ•°åï¼Œä¸ºé˜²æ­¢é™·å…¥æ— é™é˜»å¡çš„çŠ¶æ€ï¼Œä¼ é€’è¶…æ—¶(time-out)ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>è¿”å›å€¼: å‘ç”Ÿé”™è¯¯æ—¶è¿”å› -1,è¶…æ—¶æ—¶è¿”å›0,ã€‚å› å‘ç”Ÿå…³æ³¨çš„æ—¶é—´è¿”å›æ—¶ï¼Œè¿”å›å¤§äº0çš„å€¼ï¼Œè¯¥å€¼æ˜¯å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>å¦‚ä¸Šæ‰€è¿°ï¼Œselect å‡½æ•°ç”¨æ¥éªŒè¯ 3 ç§ç›‘è§†çš„å˜åŒ–æƒ…å†µï¼Œæ ¹æ®ç›‘è§†é¡¹å£°æ˜ 3 ä¸ª fd_set å‹å˜é‡ï¼Œåˆ†åˆ«å‘å…¶æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œå¹¶æŠŠå˜é‡çš„åœ°å€å€¼ä¼ é€’åˆ°ä¸Šè¿°å‡½æ•°çš„ç¬¬äºŒåˆ°ç¬¬å››ä¸ªå‚æ•°ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼ˆè°ƒç”¨ select å‡½æ•°ä¹‹å‰ï¼‰éœ€è¦å†³å®šä¸‹é¢ä¸¤ä»¶äº‹ï¼š</p><ol><li>æ–‡ä»¶æè¿°ç¬¦çš„ç›‘è§†ï¼ˆæ£€æŸ¥ï¼‰èŒƒå›´æ˜¯ï¼Ÿ</li><li>å¦‚ä½•è®¾å®š select å‡½æ•°çš„è¶…æ—¶æ—¶é—´ï¼Ÿ</li></ol><p>ç¬¬ä¸€ï¼Œæ–‡ä»¶æè¿°ç¬¦çš„ç›‘è§†èŒƒå›´å’Œ select çš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰å…³ã€‚å®é™…ä¸Šï¼Œselect å‡½æ•°è¦æ±‚é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚å› æ­¤ï¼Œéœ€è¦å¾—åˆ°æ³¨å†Œåœ¨ fd_set å˜é‡ä¸­çš„æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚ä½†æ¯æ¬¡æ–°å»ºæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œå…¶å€¼å°±ä¼šå¢åŠ  1 ï¼Œæ•…åªéœ€**å°†æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦å€¼åŠ  1 **å†ä¼ é€’ç»™ select å‡½æ•°å³å¯ã€‚åŠ  1 æ˜¯å› ä¸ºæ–‡ä»¶æè¿°ç¬¦çš„å€¼æ˜¯ä» 0 å¼€å§‹çš„ã€‚<br>ç¬¬äºŒï¼Œselect å‡½æ•°çš„è¶…æ—¶æ—¶é—´ä¸ select å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°æœ‰å…³ï¼Œå…¶ä¸­ timeval ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>timeval</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>tv_sec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>tv_usec</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></div><p>æœ¬æ¥ select å‡½æ•°åªæœ‰åœ¨ç›‘è§†æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿå˜åŒ–æ—¶æ‰è¿”å›ã€‚å¦‚æœæœªå‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚æŒ‡å®šè¶…æ—¶æ—¶é—´å°±æ˜¯ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚é€šè¿‡ä¸Šè¿°ç»“æ„ä½“å˜é‡ï¼Œå°†ç§’æ•°å¡«å…¥ tv_sec çš„æˆå‘˜ï¼Œå°†å¾®ç§’æ•°å¡«å…¥ tv_usec çš„æˆå‘˜ï¼Œç„¶åå°†ç»“æ„ä½“çš„åœ°å€å€¼ä¼ é€’åˆ° select å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°ã€‚æ­¤æ—¶ï¼Œå³ä½¿æ–‡ä»¶æè¿°ç¬¦æœªå‘ç”Ÿå˜åŒ–ï¼Œåªè¦è¿‡äº†æŒ‡å®šæ—¶é—´ï¼Œä¹Ÿå¯ä»¥ä»å‡½æ•°ä¸­è¿”å›ã€‚ä¸è¿‡è¿™ç§æƒ…å†µä¸‹ï¼Œ select å‡½æ•°è¿”å› 0 ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡è¿”å›å€¼äº†è§£åŸå› ã€‚å¦‚æœ<strong>ä¸æƒ³è®¾ç½®è¶…æ—¶ï¼Œåˆ™ä¼ é€’ NULL å‚æ•°</strong>ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>reads</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>FD_SET</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reads</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>fd_max</span> <span class=o>=</span> <span class=n>serv_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>cpy_reads</span> <span class=o>=</span> <span class=n>reads</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>fd_num</span> <span class=o>=</span> <span class=n>select</span><span class=p>(</span><span class=n>fd_max</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>cpy_reads</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>timeout</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=c1>//å¼€å§‹ç›‘è§†,æ¯æ¬¡é‡æ–°ç›‘å¬
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd_num</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>fd_max</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>cpy_reads</span><span class=p>))</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>serv_sock</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// ç­‰äºæœåŠ¡å™¨æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>adr_sz</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>clnt_adr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>clnt_sock</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clnt_adr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>adr_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>FD_SET</span><span class=p>(</span><span class=n>clnt_sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reads</span><span class=p>);</span> <span class=c1>// åŠ å…¥å®¢æˆ·ç«¯æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>fd_max</span> <span class=o>&lt;</span> <span class=n>clnt_sock</span><span class=p>)</span> <span class=n>fd_max</span> <span class=o>=</span> <span class=n>clnt_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;connect client: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>clnt_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>  <span class=p>{</span>  <span class=c1>// ç­‰äºå®¢æˆ·ç«¯æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>str_len</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>str_len</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>FD_CLR</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reads</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>close</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;close client %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>write</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>str_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=å¤šç§-io-å‡½æ•°><a href=#å¤šç§-io-å‡½æ•° class=anchor-link>#</a>å¤šç§ I/O å‡½æ•°</h2><h3 id=send--recv-å‡½æ•°><a href=#send--recv-å‡½æ•° class=anchor-link>#</a>send & recv å‡½æ•°</h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>ssize_t</span> <span class=nf>send</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>nbytes</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>sockfd: è¡¨ç¤ºä¸æ•°æ®ä¼ è¾“å¯¹è±¡çš„è¿æ¥çš„å¥—æ¥å­—å’Œæ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>buf: ä¿å­˜å¾…ä¼ è¾“æ•°æ®çš„ç¼“å†²åœ°å€å€¼
</span></span></span><span class=line><span class=cl><span class=cm>nbytes: å¾…ä¼ è¾“å­—èŠ‚æ•°
</span></span></span><span class=line><span class=cl><span class=cm>flags: ä¼ è¾“æ•°æ®æ—¶æŒ‡å®šçš„å¯é€‰é¡¹ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=n>ssize_t</span> <span class=nf>recv</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>nbytes</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„å­—èŠ‚æ•°ï¼ˆæ”¶åˆ° EOF è¿”å› 0ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>sockfd: è¡¨ç¤ºæ•°æ®æ¥å—å¯¹è±¡çš„è¿æ¥çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>buf: ä¿å­˜æ¥å—æ•°æ®çš„ç¼“å†²åœ°å€å€¼
</span></span></span><span class=line><span class=cl><span class=cm>nbytes: å¯æ¥æ”¶çš„æœ€å¤§å­—èŠ‚æ•°
</span></span></span><span class=line><span class=cl><span class=cm>flags: æ¥æ”¶æ•°æ®æ—¶æŒ‡å®šçš„å¯é€‰é¡¹å‚æ•°
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>send å’Œ recv å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯æ”¶å‘æ•°æ®çš„å¯é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å¯ä»¥ç”¨ä½æˆ–ï¼ˆbit ORï¼‰è¿ç®—ç¬¦åŒæ—¶ä¼ é€’å¤šä¸ªä¿¡æ¯ (MSG_OOB | MSG_PEEK )<br>send & recv å‡½æ•°çš„å¯é€‰é¡¹æ„ä¹‰ï¼š</p><div class=table-container><table><thead><tr><th>å¯é€‰é¡¹ï¼ˆOptionï¼‰</th><th>å«ä¹‰</th><th>send</th><th>recv</th></tr></thead><tbody><tr><td>MSG_OOB</td><td>ç”¨äºä¼ è¾“å¸¦å¤–æ•°æ®ï¼ˆOut-of-band dataï¼‰</td><td>O</td><td>O</td></tr><tr><td>MSG_PEEK</td><td>éªŒè¯è¾“å…¥ç¼“å†²ä¸­æ˜¯å¦å­˜åœ¨æ¥å—çš„æ•°æ®ï¼Œä¸ä¼šæ¸…ç©ºç¼“å†²åŒºæ•°æ®</td><td>X</td><td>O</td></tr><tr><td>MSG_DONTROUTE</td><td>æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ä¸å‚ç…§æœ¬åœ°è·¯ç”±ï¼ˆRoutingï¼‰è¡¨ï¼Œåœ¨æœ¬åœ°ï¼ˆLocalï¼‰ç½‘ç»œä¸­å¯»æ‰¾ç›®çš„åœ°</td><td>O</td><td>X</td></tr><tr><td>MSG_DONTWAIT</td><td>è°ƒç”¨ I/O å‡½æ•°æ—¶ä¸é˜»å¡ï¼Œç”¨äºä½¿ç”¨éé˜»å¡ï¼ˆNon-blockingï¼‰I/O</td><td>O</td><td>O</td></tr><tr><td>MSG_WAITALL</td><td>é˜²æ­¢å‡½æ•°è¿”å›ï¼Œç›´åˆ°æ¥æ”¶åˆ°å…¨éƒ¨è¯·æ±‚çš„å­—èŠ‚æ•°</td><td>X</td><td>O</td></tr></tbody></table></div><h4 id=msg_oobå‘é€ç´§æ€¥æ¶ˆæ¯><a href=#msg_oobå‘é€ç´§æ€¥æ¶ˆæ¯ class=anchor-link>#</a>MSG_OOBï¼šå‘é€ç´§æ€¥æ¶ˆæ¯</h4><p>ä»£ç å‚è€ƒï¼š<br><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/oob_recv.c target=_blank rel=noopener>https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/oob_recv.c</a><br><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/oob_send.c target=_blank rel=noopener>https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/oob_send.c</a><br>ä»£ç ä¸­å…³äº:</p><blockquote><p>fcntl(recv_sock, F_SETOWN, getpid());</p></blockquote><p>çš„æ„æ€æ˜¯ï¼š</p><blockquote><p>æ–‡ä»¶æè¿°ç¬¦ recv_sock æŒ‡å‘çš„å¥—æ¥å­—å¼•å‘çš„ SIGURG ä¿¡å·å¤„ç†è¿›ç¨‹å˜ä¸º getpid å‡½æ•°è¿”å›å€¼ç”¨ä½œ ID è¿›ç¨‹.</p></blockquote><p>ä¸Šè¿°æè¿°ä¸­çš„ã€Œå¤„ç† SIGURG ä¿¡å·ã€æŒ‡çš„æ˜¯ã€Œè°ƒç”¨ SIGURG ä¿¡å·å¤„ç†å‡½æ•°ã€ã€‚ä½†æ˜¯ä¹‹å‰è®²è¿‡ï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰ 1 ä¸ªå¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡è°ƒç”¨ fork å‡½æ•°åˆ›å»ºå­è¿›ç¨‹å¹¶åŒæ—¶å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ã€‚æ­¤æ—¶å¦‚æœå‘ç”Ÿ SIGURG ä¿¡å·ï¼Œåº”è¯¥è°ƒç”¨å“ªä¸ªè¿›ç¨‹çš„ä¿¡å·å¤„ç†å‡½æ•°å‘¢ï¼Ÿå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œä¸ä¼šè°ƒç”¨æ‰€æœ‰è¿›ç¨‹çš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚å› æ­¤ï¼Œå¤„ç† SIGURG ä¿¡å·æ—¶å¿…é¡»æŒ‡å®šå¤„ç†ä¿¡å·æ‰€ç”¨çš„è¿›ç¨‹ï¼Œè€Œ getpid è¿”å›çš„æ˜¯è°ƒç”¨æ­¤å‡½æ•°çš„è¿›ç¨‹ ID ã€‚ä¸Šè¿°è°ƒç”¨è¯­å¥æŒ‡<strong>å½“å‰ä¸ºå¤„ç† SIGURG ä¿¡å·çš„ä¸»ä½“</strong>ã€‚<br>è¾“å‡ºç»“æœï¼Œå¯èƒ½å‡ºä¹æ„æ–™ï¼š</p><blockquote><p>é€šè¿‡ MSG_OOB å¯é€‰é¡¹ä¼ é€’æ•°æ®æ—¶åªè¿”å› 1 ä¸ªå­—èŠ‚ï¼Œè€Œä¸”ä¹Ÿä¸å¿«</p></blockquote><p>çš„ç¡®ï¼Œé€šè¿‡ MSG_OOB å¹¶ä¸ä¼šåŠ å¿«ä¼ è¾“é€Ÿåº¦ï¼Œè€Œé€šè¿‡ä¿¡å·å¤„ç†å‡½æ•° urg_handler ä¹Ÿåªèƒ½è¯»å–ä¸€ä¸ªå­—èŠ‚ã€‚å‰©ä½™æ•°æ®åªèƒ½é€šè¿‡æœªè®¾ç½® MSG_OOB å¯é€‰é¡¹çš„æ™®é€šè¾“å…¥å‡½æ•°è¯»å–ã€‚å› ä¸º TCP ä¸å­˜åœ¨çœŸæ­£æ„ä¹‰ä¸Šçš„ã€Œå¤–å¸¦æ•°æ®ã€ã€‚å®é™…ä¸Šï¼ŒMSG_OOB ä¸­çš„ OOB æŒ‡çš„æ˜¯ Out-of-band ï¼Œè€Œã€Œå¤–å¸¦æ•°æ®ã€çš„å«ä¹‰æ˜¯ï¼š</p><blockquote><p>é€šè¿‡å®Œå…¨ä¸åŒçš„é€šä¿¡è·¯å¾„ä¼ è¾“çš„æ•°æ®</p></blockquote><p>å³çœŸæ­£æ„ä¹‰ä¸Šçš„ Out-of-band éœ€è¦é€šè¿‡å•ç‹¬çš„é€šä¿¡è·¯å¾„é«˜é€Ÿä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯ TCP ä¸å¦å¤–æä¾›ï¼Œåªåˆ©ç”¨ TCP çš„ç´§æ€¥æ¨¡å¼ï¼ˆUrgent modeï¼‰è¿›è¡Œä¼ è¾“ã€‚<br><a href=https://github.com/Rurouni-z/TCP-IP-NetworkNote/tree/master/ch13#1313-%E7%B4%A7%E6%80%A5%E6%A8%A1%E5%BC%8F%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86 target=_blank rel=noopener>ç´§æ€¥æ¨¡å¼å·¥ä½œåŸç†</a><br>æŒ‡å®š MSG_OOB é€‰é¡¹çš„æ•°æ®åŒ…æœ¬èº«å°±æ˜¯ç´§æ€¥æ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡ç´§æ€¥æŒ‡é’ˆè¡¨ç¤ºç´§æ€¥æ¶ˆæ¯æ‰€åœ¨çš„ä½ç½®ã€‚<br>ç´§æ€¥æ¶ˆæ¯çš„æ„ä¹‰åœ¨äºç£ä¿ƒæ¶ˆæ¯å¤„ç†ï¼Œè€Œéç´§æ€¥ä¼ è¾“å½¢å¼å—é™çš„ä¿¡æ¯ã€‚</p><h4 id=æ£€æŸ¥è¾“å…¥ç¼“å†²><a href=#æ£€æŸ¥è¾“å…¥ç¼“å†² class=anchor-link>#</a>æ£€æŸ¥è¾“å…¥ç¼“å†²</h4><p>åŒæ—¶è®¾ç½® MSG_PEEK é€‰é¡¹å’Œ MSG_DONTWAIT é€‰é¡¹ï¼Œä»¥éªŒè¯è¾“å…¥ç¼“å†²æ˜¯å¦å­˜åœ¨æ¥æ”¶çš„æ•°æ®ã€‚è®¾ç½® MSG_PEEK é€‰é¡¹å¹¶è°ƒç”¨ recv å‡½æ•°æ—¶ï¼Œå³ä½¿<strong>è¯»å–äº†è¾“å…¥ç¼“å†²çš„æ•°æ®ä¹Ÿä¸ä¼šåˆ é™¤</strong>ã€‚å› æ­¤ï¼Œè¯¥é€‰é¡¹é€šå¸¸ä¸ MSG_DONTWAIT ï¼ˆä¼šåˆ é™¤æ•°æ®ï¼‰åˆä½œï¼Œç”¨äºä»¥éé˜»å¡æ–¹å¼éªŒè¯å¾…è¯»æ•°æ®å­˜åœ¨ä¸å¦ã€‚</p><h3 id=readv--writev-å‡½æ•°><a href=#readv--writev-å‡½æ•° class=anchor-link>#</a>readv & writev å‡½æ•°</h3><p>readv & writev å‡½æ•°çš„åŠŸèƒ½å¯æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><blockquote><p>å¯¹æ•°æ®è¿›è¡Œæ•´åˆä¼ è¾“åŠå‘é€çš„å‡½æ•°</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡ writev å‡½æ•°å¯ä»¥å°†åˆ†æ•£ä¿å­˜åœ¨å¤šä¸ªç¼“å†²ä¸­çš„æ•°æ®ä¸€å¹¶å‘é€ï¼Œé€šè¿‡ readv å‡½æ•°å¯ä»¥ç”±å¤šä¸ªç¼“å†²åˆ†åˆ«æ¥æ”¶ã€‚å› æ­¤ï¼Œä½¿ç”¨è¿™ 2 ä¸ªå‡½æ•°å¯ä»¥å‡å°‘ I/O å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ã€‚</p><h4 id=writev-å‡½æ•°><a href=#writev-å‡½æ•° class=anchor-link>#</a>writev å‡½æ•°</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/uio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>ssize_t</span> <span class=nf>writev</span><span class=p>(</span><span class=kt>int</span> <span class=n>filedes</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=nc>iovec</span> <span class=o>*</span><span class=n>iov</span><span class=p>,</span> <span class=kt>int</span> <span class=n>iovcnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>filedes: è¡¨ç¤ºæ•°æ®ä¼ è¾“å¯¹è±¡çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚ä½†è¯¥å‡½æ•°å¹¶ä¸ä»…é™äºå¥—æ¥å­—ï¼Œå› æ­¤ï¼Œå¯ä»¥åƒ read ä¸€æ ·å‘å‘å…¶ä¼ é€’æ–‡ä»¶æˆ–æ ‡å‡†è¾“å‡ºæè¿°ç¬¦.
</span></span></span><span class=line><span class=cl><span class=cm>iov: iovec ç»“æ„ä½“æ•°ç»„çš„åœ°å€å€¼ï¼Œç»“æ„ä½“ iovec ä¸­åŒ…å«å¾…å‘é€æ•°æ®çš„ä½ç½®å’Œå¤§å°ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>iovcnt: å‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æ•°ç»„é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>iovec</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>iov_base</span><span class=p>;</span> <span class=c1>//ç¼“å†²åœ°å€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size_t</span> <span class=n>iov_len</span><span class=p>;</span> <span class=c1>//ç¼“å†²å¤§å°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-7.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png><br>writev çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤â€˜1â€™ä»£è¡¨å‘æ§åˆ¶å°è¾“å‡ºæ•°æ®ï¼Œptr æ˜¯å­˜æœ‰å¾…å‘é€æ•°æ®ä¿¡æ¯çš„ iovec æ•°ç»„æŒ‡é’ˆã€‚ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º 2ï¼Œå› æ­¤ï¼Œä» ptr æŒ‡å‘çš„åœ°å€å¼€å§‹ï¼Œå…±æµè§ˆ 2 ä¸ª iovec ç»“æ„ä½“å˜é‡ï¼Œå‘é€è¿™äº›æŒ‡é’ˆæŒ‡å‘çš„ç¼“å†²æ•°æ®ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/uio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>iovec</span> <span class=n>vec</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf1</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;ABCDEFG&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf2</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;1234567&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>str_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>buf1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>buf2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>str_len</span> <span class=o>=</span> <span class=n>writev</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>vec</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Write bytes: %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>str_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=readv-å‡½æ•°><a href=#readv-å‡½æ•° class=anchor-link>#</a>readv å‡½æ•°</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/uio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>ssize_t</span> <span class=nf>readv</span><span class=p>(</span><span class=kt>int</span> <span class=n>filedes</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=nc>iovc</span> <span class=o>*</span><span class=n>iov</span><span class=p>,</span> <span class=kt>int</span> <span class=n>iovcnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>filedes: è¡¨ç¤ºæ•°æ®ä¼ è¾“å¯¹è±¡çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚ä½†è¯¥å‡½æ•°å¹¶ä¸ä»…é™äºå¥—æ¥å­—ï¼Œå› æ­¤ï¼Œå¯ä»¥åƒ write ä¸€æ ·å‘å‘å…¶ä¼ é€’æ–‡ä»¶æˆ–æ ‡å‡†è¾“å‡ºæè¿°ç¬¦.
</span></span></span><span class=line><span class=cl><span class=cm>iov: iovec ç»“æ„ä½“æ•°ç»„çš„åœ°å€å€¼ï¼Œç»“æ„ä½“ iovec ä¸­åŒ…å«å¾…æ•°æ®ä¿å­˜çš„ä½ç½®å’Œå¤§å°ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>iovcnt: ç¬¬äºŒä¸ªå‚æ•°ä¸­æ•°ç»„çš„é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/uio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define BUF_SIZE 100
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>iovec</span> <span class=n>vec</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf1</span><span class=p>[</span><span class=n>BUF_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf2</span><span class=p>[</span><span class=n>BUF_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>str_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>buf1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span> <span class=c1>// å…ˆæ”¶å–5ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>vec</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>buf2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vec</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=n>BUF_SIZE</span><span class=p>;</span>  <span class=c1>// å†æ¥æ”¶å‰©ä¸‹100ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 0 æ§åˆ¶å°è¾“å…¥
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>str_len</span> <span class=o>=</span> <span class=n>readv</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>vec</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Read bytes: %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>str_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;First message: %s </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Second message: %s </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=åˆç†ä½¿ç”¨-readv--writev-å‡½æ•°><a href=#åˆç†ä½¿ç”¨-readv--writev-å‡½æ•° class=anchor-link>#</a>åˆç†ä½¿ç”¨ readv & writev å‡½æ•°</h4><p>å®é™…ä¸Šï¼Œèƒ½ä½¿ç”¨è¯¥å‡½æ•°çš„æ‰€æœ‰æƒ…å†µéƒ½é€‚ç”¨ã€‚ä¾‹å¦‚ï¼Œéœ€è¦ä¼ è¾“çš„æ•°æ®åˆ†åˆ«ä½äºä¸åŒç¼“å†²ï¼ˆæ•°ç»„ï¼‰æ—¶ï¼Œéœ€è¦å¤šæ¬¡è°ƒç”¨ write å‡½æ•°ã€‚æ­¤æ—¶å¯é€šè¿‡ 1 æ¬¡ writev å‡½æ•°è°ƒç”¨æ›¿ä»£æ“ä½œï¼Œå½“ç„¶ä¼šæé«˜æ•ˆç‡ã€‚åŒæ ·ï¼Œéœ€è¦å°†è¾“å…¥ç¼“å†²ä¸­çš„æ•°æ®è¯»å…¥ä¸åŒä½ç½®æ—¶ï¼Œå¯ä»¥ä¸å¿…å¤šæ¬¡è°ƒç”¨ read å‡½æ•°ï¼Œè€Œæ˜¯åˆ©ç”¨ 1 æ¬¡ readv å‡½æ•°å°±èƒ½å¤§å¤§æé«˜æ•ˆç‡ã€‚<br>å…¶æ„ä¹‰åœ¨äº<strong>å‡å°‘æ•°æ®åŒ…ä¸ªæ•°</strong>ã€‚å‡è®¾ä¸ºäº†æé«˜æ•ˆç‡åœ¨æœåŠ¡å™¨ç«¯æ˜ç¡®ç¦ç”¨äº† Nagle ç®—æ³•ã€‚å…¶å® writev å‡½æ•°åœ¨ä¸é‡‡ç”¨ Nagle ç®—æ³•æ—¶æ›´æœ‰ä»·å€¼ï¼Œå¦‚å›¾ï¼š<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-8.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></p><h2 id=å¤šæ’­ä¸å¹¿æ’­><a href=#å¤šæ’­ä¸å¹¿æ’­ class=anchor-link>#</a>å¤šæ’­ä¸å¹¿æ’­</h2><h3 id=å¤šæ’­><a href=#å¤šæ’­ class=anchor-link>#</a>å¤šæ’­</h3><p>å¤šæ’­ï¼ˆMulticastï¼‰æ–¹å¼çš„æ•°æ®ä¼ è¾“æ˜¯<strong>åŸºäº UDP <strong>å®Œæˆçš„ã€‚å› æ­¤ ï¼Œä¸ UDP æœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯çš„å®ç°æ–¹å¼éå¸¸æ¥è¿‘ã€‚åŒºåˆ«åœ¨äºï¼ŒUDP æ•°æ®ä¼ è¾“ä»¥å•ä¸€ç›®æ ‡è¿›è¡Œï¼Œè€Œå¤šæ’­æ•°æ®åŒæ—¶ä¼ é€’åˆ°åŠ å…¥ï¼ˆæ³¨å†Œï¼‰ç‰¹å®šç»„çš„å¤§é‡ä¸»æœºã€‚æ¢è¨€ä¹‹ï¼Œé‡‡ç”¨å¤šæ’­æ–¹å¼æ—¶ï¼Œå¯ä»¥</strong>åŒæ—¶å‘å¤šä¸ªä¸»æœºä¼ é€’æ•°æ®</strong>ã€‚</p><h4 id=å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹><a href=#å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹ class=anchor-link>#</a>å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹</h4><p>å¤šæ’­çš„æ•°æ®ä¼ è¾“ç‰¹ç‚¹å¯æ•´ç†å¦‚ä¸‹ï¼š</p><ul><li>å¤šæ’­<strong>æœåŠ¡å™¨ç«¯</strong>é’ˆå¯¹ç‰¹å®šå¤šæ’­ç»„ï¼Œåª<strong>å‘é€ 1 æ¬¡</strong>æ•°æ®ã€‚</li><li>å³ä½¿åªå‘é€ 1 æ¬¡æ•°æ®ï¼Œä½†è¯¥ç»„å†…çš„æ‰€æœ‰å®¢æˆ·ç«¯<strong>éƒ½ä¼šæ¥æ”¶æ•°æ®</strong></li><li>å¤šæ’­ç»„æ•°å¯ä»¥åœ¨ IP åœ°å€èŒƒå›´å†…ä»»æ„å¢åŠ </li></ul><p>å¤šæ’­ç»„æ˜¯ D ç±»IPåœ°å€ï¼ˆ224.0.0.0~239.255.255.255ï¼‰ï¼Œã€ŒåŠ å…¥å¤šæ’­ç»„ã€å¯ä»¥ç†è§£ä¸ºé€šè¿‡ç¨‹åºå®Œæˆå¦‚ä¸‹å£°æ˜ï¼š</p><blockquote><p>åœ¨ D ç±»IPåœ°å€ä¸­ï¼Œæˆ‘å¸Œæœ›æ¥æ”¶å‘å¾€ç›®æ ‡ 239.234.218.234 çš„å¤šæ’­æ•°æ®</p></blockquote><p>å¤šæ’­æ˜¯åŸºäº UDP å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šæ’­æ•°æ®åŒ…çš„æ ¼å¼ä¸ UDP æ•°æ®åŒ…ç›¸åŒã€‚åªæ˜¯ä¸ä¸€èˆ¬çš„ UDP æ•°æ®åŒ…ä¸åŒã€‚å‘ç½‘ç»œä¼ é€’ 1 ä¸ªå¤šæ’­æ•°æ®åŒ…æ—¶ï¼Œè·¯ç”±å™¨å°†å¤åˆ¶è¯¥æ•°æ®åŒ…å¹¶ä¼ é€’åˆ°å¤šä¸ªä¸»æœºã€‚åƒè¿™æ ·ï¼Œå¤šæ’­éœ€è¦å€ŸåŠ©è·¯ç”±å™¨å®Œæˆã€‚å¦‚å›¾æ‰€ç¤ºï¼š<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-9.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-9.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=FciD5&amp;originHeight=319&amp;originWidth=540&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>è‹¥é€šè¿‡ TCP æˆ– UDP å‘ 1000 ä¸ªä¸»æœºå‘é€æ–‡ä»¶ï¼Œåˆ™å…±éœ€è¦ä¼ é€’ 1000 æ¬¡ã€‚ä½†æ˜¯æ­¤æ—¶å¦‚æœç”¨å¤šæ’­ç½‘ç»œä¼ è¾“æ–‡ä»¶ï¼Œåˆ™åªéœ€è¦å‘é€ä¸€æ¬¡ã€‚è¿™æ—¶ç”± 1000 å°ä¸»æœºæ„æˆçš„ç½‘ç»œä¸­çš„è·¯ç”±å™¨è´Ÿè´£å¤åˆ¶æ–‡ä»¶å¹¶ä¼ é€’åˆ°ä¸»æœºã€‚å°±å› ä¸ºè¿™ç§ç‰¹æ€§ï¼Œå¤šæ’­ä¸»è¦ç”¨äºã€Œ<strong>å¤šåª’ä½“æ•°æ®å®æ—¶ä¼ è¾“</strong>ã€ã€‚<br>å¦å¤–ï¼Œç†è®ºä¸Šå¯ä»¥å®Œæˆå¤šæ’­é€šä¿¡ï¼Œä½†æ˜¯ä¸å°‘è·¯ç”±å™¨å¹¶ä¸æ”¯æŒå¤šæ’­ï¼Œæˆ–å³ä¾¿æ”¯æŒä¹Ÿå› ç½‘ç»œæ‹¥å µé—®é¢˜æ•…æ„é˜»æ–­å¤šæ’­ã€‚å› æ­¤ï¼Œä¸ºäº†åœ¨ä¸æ”¯æŒå¤šæ’­çš„è·¯ç”±å™¨ä¸­å®Œæˆå¤šæ’­é€šä¿¡ï¼Œä¹Ÿä¼š<strong>ä½¿ç”¨éš§é“ï¼ˆTunnelingï¼‰æŠ€æœ¯</strong>ã€‚</p><h4 id=è·¯ç”±routingå’Œ-ttltime-to-liveç”Ÿå­˜æ—¶é—´ä»¥åŠåŠ å…¥ç»„çš„åŠæ³•><a href=#è·¯ç”±routingå’Œ-ttltime-to-liveç”Ÿå­˜æ—¶é—´ä»¥åŠåŠ å…¥ç»„çš„åŠæ³• class=anchor-link>#</a>è·¯ç”±ï¼ˆRoutingï¼‰å’Œ TTLï¼ˆTime to Live,ç”Ÿå­˜æ—¶é—´ï¼‰ï¼Œä»¥åŠåŠ å…¥ç»„çš„åŠæ³•</h4><p>ä¸ºäº†ä¼ é€’å¤šæ’­æ•°æ®åŒ…ï¼Œå¿…é¡»è®¾ç½® TTL ã€‚TTL æ˜¯ Time to Liveçš„ç®€å†™ï¼Œæ˜¯å†³å®šã€Œæ•°æ®åŒ…ä¼ é€’è·ç¦»ã€çš„ä¸»è¦å› ç´ ã€‚TTL ç”¨æ•´æ•°è¡¨ç¤ºï¼Œå¹¶ä¸”<strong>æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨å°±å‡ä¸€</strong>ã€‚TTL å˜ä¸º 0 æ—¶ï¼Œè¯¥æ•°æ®åŒ…å°±æ— æ³•å†è¢«ä¼ é€’ï¼Œåªèƒ½é”€æ¯ã€‚å› æ­¤ï¼ŒTTL çš„å€¼è®¾ç½®è¿‡å¤§å°†å½±å“ç½‘ç»œæµé‡ã€‚å½“ç„¶ï¼Œè®¾ç½®è¿‡å°ï¼Œä¹Ÿæ— æ³•ä¼ é€’åˆ°ç›®æ ‡ã€‚<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-10.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png><br>TTL æ˜¯å¯ä»¥é€šè¿‡ç¬¬ä¹ç« çš„å¥—æ¥å­—å¯é€‰é¡¹å®Œæˆçš„ã€‚ä¸è®¾ç½® TTL ç›¸å…³çš„åè®®å±‚ä¸º IPPROTO_IP ï¼Œé€‰é¡¹åä¸º IP_MULTICAST_TTLã€‚ç”¨å¦‚ä¸‹ä»£ç æŠŠ TTL è®¾ç½®ä¸º 64:</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>send_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>time_live</span> <span class=o>=</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>send_sock</span><span class=o>=</span><span class=n>socket</span><span class=p>(</span><span class=n>PF_INET</span><span class=p>,</span><span class=n>SOCK_DGRAM</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>setsockopt</span><span class=p>(</span><span class=n>send_sock</span><span class=p>,</span><span class=n>IPPROTO_IP</span><span class=p>,</span><span class=n>IP_MULTICAST_TTL</span><span class=p>,(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>time_live</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>time_live</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div></div><p>åŠ å…¥å¤šæ’­ç»„ä¹Ÿé€šè¿‡è®¾ç½®å¥—æ¥å­—å¯é€‰é¡¹æ¥å®Œæˆã€‚åŠ å…¥å¤šæ’­ç»„ç›¸å…³çš„åè®®å±‚ä¹Ÿä¸º IPPROTO_IPï¼Œé€‰é¡¹åä¸º IP_ADD_MEMBERSHIP ã€‚å¯é€šè¿‡å¦‚ä¸‹ä»£ç åŠ å…¥å¤šæ’­ç»„ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>recv_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>ip_mreq</span> <span class=n>join_adr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>recv_sock</span><span class=o>=</span><span class=n>socket</span><span class=p>(</span><span class=n>PF_INET</span><span class=p>,</span><span class=n>SOCK_DGRAM</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>join_adr</span><span class=p>.</span><span class=n>imr_multiaddr</span><span class=p>.</span><span class=n>s_addr</span><span class=o>=</span><span class=s>&#34;å¤šæ’­ç»„åœ°å€ä¿¡æ¯&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>join_adr</span><span class=p>.</span><span class=n>imr_interface</span><span class=p>.</span><span class=n>s_addr</span><span class=o>=</span><span class=s>&#34;åŠ å…¥å¤šæ’­ç»„çš„ä¸»æœºåœ°å€ä¿¡æ¯&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>setsockopt</span><span class=p>(</span><span class=n>recv_sock</span><span class=p>,</span><span class=n>IPPROTO_IP</span><span class=p>,</span><span class=n>IP_ADD_MEMBERSHIP</span><span class=p>,(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>join_adr</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>join_adr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>ip_mreq</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>in_addr</span> <span class=n>imr_multiaddr</span><span class=p>;</span>  <span class=c1>// å¤šæ’­ç»„çš„IPåœ°å€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=nc>in_addr</span> <span class=n>imr_interface</span><span class=p>;</span>  <span class=c1>// å¾…åŠ å…¥çš„IPåœ°å€
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=s>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=å®ç°å¤šæ’­-sender-å’Œ-receiver><a href=#å®ç°å¤šæ’­-sender-å’Œ-receiver class=anchor-link>#</a>å®ç°å¤šæ’­ Sender å’Œ Receiver</h4><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_sender.c target=_blank rel=noopener>news_sender.c</a></li><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_receiver.c target=_blank rel=noopener>news_receiver.c</a></li><li>ä»£ç ä¸­recviverä¸ä¼šåœæ­¢ï¼Œé˜»å¡ç­‰å¾…senderæ¶ˆæ¯</li><li>å»¶è¿Ÿè¿è¡Œ receiver å°†æ— æ³•æ¥å—ä¹‹å‰å‘é€çš„ä¿¡æ¯ã€‚</li></ul><h3 id=å¹¿æ’­><a href=#å¹¿æ’­ class=anchor-link>#</a>å¹¿æ’­</h3><p>å¤šæ’­å³ä½¿åœ¨è·¨è¶Šä¸åŒç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œåªè¦åŠ å…¥å¤šæ’­ç»„å°±èƒ½æ¥å—æ•°æ®ã€‚ç›¸åï¼Œå¹¿æ’­åªèƒ½å‘åŒä¸€ç½‘ç»œä¸­çš„ä¸»æœºä¼ è¾“æ•°æ®ã€‚å¤šæ’­ä¼ è¾“æ•°æ®çš„èŒƒå›´æœ‰åŒºåˆ«ã€‚</p><h4 id=å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼><a href=#å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼ class=anchor-link>#</a>å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹å¼</h4><p>å¹¿æ’­æ˜¯å‘åŒä¸€ç½‘ç»œä¸­çš„æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®çš„æ–¹æ³•ã€‚ä¸å¤šæ’­ç›¸åŒï¼Œå¹¿æ’­ä¹Ÿæ˜¯é€šè¿‡ UDP æ¥å®Œæˆçš„ã€‚æ ¹æ®ä¼ è¾“æ•°æ®æ—¶ä½¿ç”¨çš„IPåœ°å€å½¢å¼ï¼Œå¹¿æ’­åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š</p><ul><li>ç›´æ¥å¹¿æ’­ï¼ˆDirected Broadcastï¼‰</li><li>æœ¬åœ°å¹¿æ’­ï¼ˆLocal Broadcastï¼‰</li></ul><p>äºŒè€…åœ¨å®ç°ä¸Šçš„å·®åˆ«ä¸»è¦åœ¨äºIPåœ°å€ã€‚ç›´æ¥å¹¿æ’­çš„IPåœ°å€ä¸­é™¤äº†ç½‘ç»œåœ°å€å¤–ï¼Œ<strong>å…¶ä½™ä¸»æœºåœ°å€å…¨éƒ¨è®¾ç½®æˆ 1</strong>ã€‚ä¾‹å¦‚ï¼Œå¸Œæœ›å‘ç½‘ç»œåœ°å€ 192.12.34 ä¸­çš„æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®æ—¶ï¼Œå¯ä»¥å‘ 192.12.34.255 ä¼ è¾“ã€‚æ¢è¨€ä¹‹ï¼Œå¯ä»¥é‡‡å–ç›´æ¥å¹¿æ’­çš„æ–¹å¼<strong>å‘ç‰¹å®šåŒºåŸŸå†…æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®</strong>ã€‚<br>åä¹‹ï¼Œæœ¬åœ°å¹¿æ’­ä¸­ä½¿ç”¨çš„IPåœ°å€é™å®šä¸º 255.255.255.255 ã€‚ä¾‹å¦‚ï¼Œ192.32.24 <strong>ç½‘ç»œä¸­çš„ä¸»æœº</strong>å‘ 255.255.255.255 ä¼ è¾“æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼ è¾“åˆ° 192.32.24 <strong>ç½‘ç»œä¸­æ‰€æœ‰ä¸»æœº</strong>ã€‚<br><strong>æ•°æ®é€šä¿¡ä¸­ä½¿ç”¨çš„IPåœ°å€æ˜¯ä¸ UDP ç¤ºä¾‹çš„å”¯ä¸€åŒºåˆ«ã€‚é»˜è®¤ç”Ÿæˆçš„å¥—æ¥å­—ä¼šé˜»æ­¢å¹¿æ’­ï¼Œå› æ­¤ï¼Œåªéœ€é€šè¿‡å¦‚ä¸‹ä»£ç æ›´æ”¹é»˜è®¤è®¾ç½®ã€‚</strong></p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>send_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>bcast</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>send_sock</span><span class=o>=</span><span class=n>socket</span><span class=p>(</span><span class=n>PF_INET</span><span class=p>,</span><span class=n>SOCK_DGRAM</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>setsockopt</span><span class=p>(</span><span class=n>send_sock</span><span class=p>,</span><span class=n>SOL_SOCKET</span><span class=p>,</span><span class=n>SO_BROADCAST</span><span class=p>,(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>bcast</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>bcast</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä¸‹é¢æ˜¯å¹¿æ’­æ•°æ®çš„ Sender å’Œ Receiverçš„ä»£ç ï¼š</p><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_sender_brd.c target=_blank rel=noopener>news_sender_brd.c</a></li><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_receiver_brd.c target=_blank rel=noopener>news_receiver_brd.c</a></li></ul><h2 id=å¥—æ¥å­—å’Œæ ‡å‡†io><a href=#å¥—æ¥å­—å’Œæ ‡å‡†io class=anchor-link>#</a>å¥—æ¥å­—å’Œæ ‡å‡†I/O</h2><h3 id=æ ‡å‡†-io-çš„ä¼˜ç¼ºç‚¹><a href=#æ ‡å‡†-io-çš„ä¼˜ç¼ºç‚¹ class=anchor-link>#</a>æ ‡å‡† I/O çš„ä¼˜ç¼ºç‚¹</h3><ul><li>ä¼˜ç‚¹<ul><li>æ ‡å‡† I/O å‡½æ•°å…·æœ‰è‰¯å¥½çš„ç§»æ¤æ€§</li><li>æ ‡å‡† I/O å‡½æ•°å¯ä»¥åˆ©ç”¨ç¼“å†²æé«˜æ€§èƒ½</li></ul></li><li>ç¼ºç‚¹<ul><li>ä¸å®¹æ˜“è¿›è¡ŒåŒå‘é€šä¿¡</li><li>æœ‰æ—¶å¯èƒ½é¢‘ç¹è°ƒç”¨ fflush å‡½æ•°</li><li>éœ€è¦ä»¥ FILE ç»“æ„ä½“æŒ‡é’ˆçš„å½¢å¼è¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚</li></ul></li></ul><p>åˆ›å»ºå¥—æ¥å­—æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå‡†å¤‡ I/O ç¼“å†²ã€‚æ­¤ç¼“å†²åœ¨æ‰§è¡Œ TCP åè®®æ—¶å‘æŒ¥ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚æ­¤æ—¶è‹¥ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°ï¼Œå°†å¾—åˆ°<strong>é¢å¤–çš„ç¼“å†²æ”¯æŒ</strong>ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-11.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png><br>å‡è®¾ä½¿ç”¨ fputs å‡½æ•°è¿›è¡Œä¼ è¾“å­—ç¬¦ä¸² ã€ŒHelloã€æ—¶ï¼Œé¦–å…ˆå°†æ•°æ®ä¼ é€’åˆ°æ ‡å‡† I/O ç¼“å†²ï¼Œç„¶åå°†æ•°æ®ç§»åŠ¨åˆ°å¥—æ¥å­—è¾“å‡ºç¼“å†²ï¼Œæœ€åfflushå°†å­—ç¬¦ä¸²å‘é€åˆ°å¯¹æ–¹ä¸»æœºã€‚</p><h3 id=ä½¿ç”¨æ ‡å‡†-io-å‡½æ•°><a href=#ä½¿ç”¨æ ‡å‡†-io-å‡½æ•° class=anchor-link>#</a>ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°</h3><h4 id=åˆ©ç”¨-fdopen-å‡½æ•°è½¬æ¢ä¸º-file-ç»“æ„ä½“æŒ‡é’ˆ><a href=#åˆ©ç”¨-fdopen-å‡½æ•°è½¬æ¢ä¸º-file-ç»“æ„ä½“æŒ‡é’ˆ class=anchor-link>#</a>åˆ©ç”¨ fdopen å‡½æ•°è½¬æ¢ä¸º FILE ç»“æ„ä½“æŒ‡é’ˆ</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>FILE</span> <span class=o>*</span><span class=nf>fdopen</span><span class=p>(</span><span class=kt>int</span> <span class=n>fildes</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>å°†æ–‡ä»¶æè¿°ç¬¦è½¬æ¢ä¸ºæ ‡å‡†IO
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›è½¬æ¢çš„ FILE ç»“æ„ä½“æŒ‡é’ˆï¼Œå¤±è´¥æ—¶è¿”å› NULL
</span></span></span><span class=line><span class=cl><span class=cm>fildes ï¼š éœ€è¦è½¬æ¢çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>mode ï¼š å°†è¦åˆ›å»ºçš„ FILE ç»“æ„ä½“æŒ‡é’ˆçš„æ¨¡å¼ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=åˆ©ç”¨-fileno-å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦><a href=#åˆ©ç”¨-fileno-å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ class=anchor-link>#</a>åˆ©ç”¨ fileno å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>fileno</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=åŸºäºå¥—æ¥å­—çš„æ ‡å‡†-io-å‡½æ•°ä½¿ç”¨><a href=#åŸºäºå¥—æ¥å­—çš„æ ‡å‡†-io-å‡½æ•°ä½¿ç”¨ class=anchor-link>#</a>åŸºäºå¥—æ¥å­—çš„æ ‡å‡† I/O å‡½æ•°ä½¿ç”¨</h3><p>æŠŠç¬¬å››ç« çš„å›å£°å®¢æˆ·ç«¯å’Œå›å£°æœåŠ¡ç«¯çš„å†…å®¹æ”¹ä¸ºåŸºäºæ ‡å‡† I/O å‡½æ•°çš„æ•°æ®äº¤æ¢å½¢å¼ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/echo_client.c target=_blank rel=noopener>echo_client.c</a></li><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/echo_stdserv.c target=_blank rel=noopener>echo_stdserv.c</a></li></ul><h2 id=io-æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹><a href=#io-æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹ class=anchor-link>#</a>I/O æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹</h2><p>ä¹‹å‰ä¸¤ç§åˆ†ç¦»æ–¹æ³•ï¼š</p><ul><li>ç¬¬ä¸€ç§æ˜¯ã€ŒTCP I/O è¿‡ç¨‹ã€åˆ†ç¦»ã€‚é€šè¿‡<strong>è°ƒç”¨ fork å‡½æ•°</strong>å¤åˆ¶å‡ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥åŒºåˆ†è¾“å…¥å’Œè¾“å‡ºä¸­ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è™½ç„¶æ–‡ä»¶æè¿°ç¬¦æœ¬èº«ä¸ä¼šæ ¹æ®è¾“å…¥å’Œè¾“å‡ºè¿›è¡ŒåŒºåˆ†ï¼Œä½†æˆ‘ä»¬åˆ†å¼€äº† 2 ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ç”¨é€”ï¼Œå› æ­¤ï¼Œè¿™ä¹Ÿå±äºã€Œæµã€çš„åˆ†ç¦»ã€‚</li><li>ç¬¬äºŒç§åˆ†ç¦»æ˜¯é€šè¿‡ 2 æ¬¡<strong>è°ƒç”¨fdopen å‡½æ•°</strong>ï¼Œåˆ›å»ºè¯»æ¨¡å¼ FILE æŒ‡é’ˆï¼ˆFILE ç»“æ„ä½“æŒ‡é’ˆï¼‰å’Œå†™æ¨¡å¼ FILE æŒ‡é’ˆã€‚æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬åˆ†ç¦»äº†è¾“å…¥å·¥å…·å’Œè¾“å‡ºå·¥å…·ï¼Œå› æ­¤ä¹Ÿå¯è§†ä¸ºã€Œæµã€çš„åˆ†ç¦»ã€‚ä¸‹é¢æ˜¯åˆ†ç¦»çš„ç†ç”±ã€‚</li></ul><h4 id=åˆ†ç¦»æµçš„å¥½å¤„><a href=#åˆ†ç¦»æµçš„å¥½å¤„ class=anchor-link>#</a>åˆ†ç¦»ã€Œæµã€çš„å¥½å¤„</h4><p>é¦–å…ˆæ˜¯forkçš„åˆ†ç¦»ç›®çš„ï¼š</p><ul><li>é€šè¿‡åˆ†å¼€è¾“å…¥è¿‡ç¨‹ï¼ˆä»£ç ï¼‰å’Œè¾“å‡ºè¿‡ç¨‹é™ä½å®ç°éš¾åº¦</li><li>ä¸è¾“å…¥æ— å…³çš„è¾“å‡ºæ“ä½œå¯ä»¥æé«˜é€Ÿåº¦</li></ul><p>ä¸‹é¢æ˜¯fdopenåˆ†ç¦»çš„ç›®çš„ï¼š</p><ul><li>ä¸ºäº†å°† FILE æŒ‡é’ˆæŒ‰è¯»æ¨¡å¼å’Œå†™æ¨¡å¼åŠ ä»¥åŒºåˆ†</li><li>å¯ä»¥é€šè¿‡åŒºåˆ†è¯»å†™æ¨¡å¼é™ä½å®ç°éš¾åº¦</li><li>é€šè¿‡åŒºåˆ† I/O ç¼“å†²æé«˜ç¼“å†²æ€§èƒ½</li></ul><h4 id=æµåˆ†ç¦»å¸¦æ¥çš„-eof-é—®é¢˜><a href=#æµåˆ†ç¦»å¸¦æ¥çš„-eof-é—®é¢˜ class=anchor-link>#</a>ã€Œæµã€åˆ†ç¦»å¸¦æ¥çš„ EOF é—®é¢˜</h4><p>close()ä¸€ä¸ªfdopenä¼šå…³é—­æ•´ä¸ªå¥—æ¥å­—<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12600461/1689249181825-0c3d1dcb-c148-4a37-895c-3847e35814bf.png#averageHue=%23d5d5d5&amp;clientId=ud362a5e0-75d0-4&amp;from=paste&amp;height=165&amp;id=u340713e9&amp;originHeight=198&amp;originWidth=470&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;size=70970&amp;status=done&amp;style=none&amp;taskId=udc8d66f8-5e2c-407e-a380-e88a9cae3d2&amp;title=&amp;width=391.6666666666667" alt=å›¾ç‰‡.png><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12600461/1689249194614-bbc5b267-3632-412f-8403-8be5fd246c3d.png#averageHue=%23d6d6d6&amp;clientId=ud362a5e0-75d0-4&amp;from=paste&amp;height=174&amp;id=ubec88290&amp;originHeight=209&amp;originWidth=463&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;size=80887&amp;status=done&amp;style=none&amp;taskId=u58c328a6-bafc-40a1-b08b-011ea96fef9&amp;title=&amp;width=385.83333333333337" alt=å›¾ç‰‡.png><br>åªéœ€è¦åˆ›å»º FILE æŒ‡é’ˆå‰<strong>å…ˆå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</strong>å³å¯ã€‚å¤åˆ¶åå¦å¤–åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶ååˆ©ç”¨å„è‡ªçš„æ–‡ä»¶æè¿°ç¬¦ç”Ÿæˆè¯»æ¨¡å¼çš„ FILE æŒ‡é’ˆå’Œå†™æ¨¡å¼çš„ FILE æŒ‡é’ˆã€‚<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-12.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png><br>è¿™å°±ä¸ºåŠå…³é—­åˆ›é€ å¥½äº†ç¯å¢ƒï¼Œå› ä¸ºå¥—æ¥å­—å’Œæ–‡ä»¶æè¿°ç¬¦å…·æœ‰å¦‚ä¸‹å…³ç³»ï¼š</p><blockquote><p>é”€æ¯æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦å€™æ‰èƒ½é”€æ¯å¥—æ¥å­—</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé’ˆå¯¹å†™æ¨¡å¼ FILE æŒ‡é’ˆè°ƒç”¨ fclose å‡½æ•°æ—¶ï¼Œåªèƒ½é”€æ¯ä¸è¯¥ FILE æŒ‡é’ˆç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ— æ³•é”€æ¯å¥—æ¥å­—ã€‚<br>é‚£ä¹ˆè°ƒç”¨ fclose å‡½æ•°å€™è¿˜å‰©ä¸‹ 1 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æ²¡æœ‰é”€æ¯å¥—æ¥å­—ã€‚é‚£æ­¤æ—¶çš„çŠ¶æ€æ˜¯å¦ä¸ºåŠå…³é—­çŠ¶æ€ï¼Ÿä¸æ˜¯ï¼åªæ˜¯å‡†å¤‡å¥½äº†è¿›å…¥åŠå…³é—­çŠ¶æ€ï¼Œè€Œä¸æ˜¯å·²ç»è¿›å…¥äº†åŠå…³é—­çŠ¶æ€ã€‚ä»”ç»†è§‚å¯Ÿï¼Œè¿˜å‰©ä¸‹ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚è€Œè¯¥æ–‡ä»¶æè¿°ç¬¦å¯ä»¥åŒæ—¶è¿›è¡Œ I/O ã€‚å› æ­¤ï¼Œä¸ä½†æ²¡æœ‰å‘é€ EOF ï¼Œè€Œä¸”ä»ç„¶å¯ä»¥åˆ©ç”¨æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¾“å‡ºã€‚</p><h5 id=æµçš„åˆ†ç¦»><a href=#æµçš„åˆ†ç¦» class=anchor-link>#</a>æµçš„åˆ†ç¦»</h5><ol><li>å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ç”¨dup/dup2å‡½æ•°</li></ol><p>ä¸è°ƒç”¨ fork å‡½æ•°ä¸åŒï¼Œè°ƒç”¨ fork å‡½æ•°å°†å¤åˆ¶æ•´ä¸ªè¿›ç¨‹ï¼Œæ­¤å¤„è®¨è®ºçš„æ˜¯åŒä¸€è¿›ç¨‹å†…å®Œæˆå¯¹å®Œæˆæè¿°ç¬¦çš„å¤åˆ¶ã€‚å¦‚å›¾ï¼š<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-13.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>dup</span><span class=p>(</span><span class=kt>int</span> <span class=n>fildes</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>dup2</span><span class=p>(</span><span class=kt>int</span> <span class=n>fildes</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fildes2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>fildes : éœ€è¦å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>fildes2 : æ˜ç¡®æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦çš„æ•´æ•°å€¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>dup2 å‡½æ•°æ˜ç¡®æŒ‡å®šå¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•´æ•°å€¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>å‘å…¶ä¼ é€’å¤§äº 0 ä¸”å°äºè¿›ç¨‹èƒ½ç”Ÿæˆçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼æ—¶ï¼Œ
</span></span></span><span class=line><span class=cl><span class=cm>è¯¥å€¼å°†æˆä¸ºå¤åˆ¶å‡ºçš„æ–‡ä»¶æè¿°ç¬¦å€¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>0 stdinï¼›1 stdoutï¼›2 error
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><ol start=2><li>ä½¿ç”¨shutdownï¼ŒåŠå…³é—­æè¿°ç¬¦<ol><li>shutdown(fileno(writefp), SHUT_WR);</li><li>close(writefp)</li><li><a href=https://beej.us/guide/bgnet/html/#close-and-shutdownget-outta-my-face target=_blank rel=noopener>It's important to note </a>that shutdown() doesn't actually close the file descriptorâ€”it just <strong>changes its usability</strong>. To free a socket descriptor, you need to use close().</li></ol></li></ol><h2 id=ä¼˜äº-select-çš„-epoll><a href=#ä¼˜äº-select-çš„-epoll class=anchor-link>#</a>ä¼˜äº select çš„ epoll</h2><h3 id=epoll-ç†è§£åŠåº”ç”¨><a href=#epoll-ç†è§£åŠåº”ç”¨ class=anchor-link>#</a>epoll ç†è§£åŠåº”ç”¨</h3><p>select å¤ç”¨æ–¹æ³•ç”±æ¥å·²ä¹…ï¼Œå› æ­¤ï¼Œåˆ©ç”¨è¯¥æŠ€æœ¯åï¼Œæ— è®ºå¦‚ä½•ä¼˜åŒ–ç¨‹åºæ€§èƒ½ä¹Ÿ<strong>æ— æ³•åŒæ—¶ä»‹å…¥ä¸Šç™¾ä¸ªå®¢æˆ·ç«¯</strong>ã€‚</p><h4 id=åŸºäº-select-çš„-io-å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› ><a href=#åŸºäº-select-çš„-io-å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå›  class=anchor-link>#</a>åŸºäº select çš„ I/O å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› </h4><p>ç¬¬ 12 ç« å®ç°äº†åŸºäº select çš„ I/O å¤ç”¨æŠ€æœ¯æœåŠ¡ç«¯ï¼Œå…¶ä¸­æœ‰ä¸åˆç†çš„è®¾è®¡å¦‚ä¸‹ï¼š</p><ul><li>è°ƒç”¨ select å‡½æ•°åå¸¸è§çš„é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯è¯­å¥</li><li>æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶éƒ½éœ€è¦å‘è¯¥å‡½æ•°ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯</li></ul><p>ä¸Šè¿°ä¸¤ç‚¹å¯ä»¥ä» <a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch12/echo_selectserv.c target=_blank rel=noopener>echo_selectserv.c</a> å¾—åˆ°ç¡®è®¤ï¼Œè°ƒç”¨ select å‡½æ•°åï¼Œå¹¶ä¸æ˜¯æŠŠå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦å•ç‹¬é›†ä¸­åœ¨ä¸€èµ·ï¼Œè€Œæ˜¯é€šè¿‡<strong>ä½œä¸ºç›‘è§†å¯¹è±¡çš„ fd_set å˜é‡çš„å˜åŒ–ï¼Œæ‰¾å‡ºå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦</strong>ï¼ˆ54,56è¡Œï¼‰ï¼Œå› æ­¤æ— æ³•é¿å…é’ˆå¯¹æ‰€æœ‰ç›‘è§†å¯¹è±¡çš„å¾ªç¯è¯­å¥ã€‚è€Œä¸”ï¼Œä½œä¸ºç›‘è§†å¯¹è±¡çš„ fd_set ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥è°ƒç”¨ select å‡½æ•°å‰åº”è¯¥å¤åˆ¶å¹¶ä¿å­˜åŸæœ‰ä¿¡æ¯ï¼Œå¹¶åœ¨æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶<strong>ä¼ é€’æ–°çš„ç›‘è§†å¯¹è±¡ä¿¡æ¯</strong>ã€‚<br>select æ€§èƒ½ä¸Šæœ€å¤§çš„å¼±ç‚¹æ˜¯ï¼š<strong>æ¯æ¬¡ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯</strong>ï¼Œå‡†ç¡®çš„è¯´ï¼Œselect æ˜¯ç›‘è§†å¥—æ¥å­—å˜åŒ–çš„å‡½æ•°ã€‚è€Œå¥—æ¥å­—æ˜¯æ“ä½œç³»ç»Ÿç®¡ç†çš„ï¼Œæ‰€ä»¥ select å‡½æ•°è¦å€ŸåŠ©æ“ä½œç³»ç»Ÿæ‰èƒ½å®ŒæˆåŠŸèƒ½ã€‚select å‡½æ•°çš„è¿™ä¸€ç¼ºç‚¹å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å¼¥è¡¥ï¼š</p><blockquote><p>ä»…å‘æ“ä½œç³»ç»Ÿä¼ é€’ä¸€æ¬¡ç›‘è§†å¯¹è±¡ï¼Œç›‘è§†èŒƒå›´æˆ–å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶åªé€šçŸ¥å‘ç”Ÿå˜åŒ–çš„äº‹é¡¹</p></blockquote><p>è¿™æ ·å°±æ— éœ€æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶éƒ½å‘æ“ä½œç³»ç»Ÿä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ï¼Œä½†æ˜¯å‰ææ“ä½œç³»ç»Ÿæ”¯æŒè¿™ç§å¤„ç†æ–¹å¼ã€‚Linux çš„æ”¯æŒæ–¹å¼æ˜¯ epoll ï¼ŒWindows çš„æ”¯æŒæ–¹å¼æ˜¯ IOCPã€‚</p><h4 id=select-ä¼˜ç‚¹><a href=#select-ä¼˜ç‚¹ class=anchor-link>#</a>select ä¼˜ç‚¹</h4><p>select çš„å…¼å®¹æ€§æ¯”è¾ƒé«˜ï¼Œè¿™æ ·å°±å¯ä»¥æ”¯æŒå¾ˆå¤šçš„æ“ä½œç³»ç»Ÿï¼Œä¸å—å¹³å°çš„é™åˆ¶ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä½¿å¯ä»¥ä½¿ç”¨ select å‡½æ•°ï¼š</p><ul><li>æœåŠ¡å™¨æ¥å…¥è€…å°‘</li><li>ç¨‹åºåº”è¯¥å…·æœ‰å…¼å®¹æ€§</li></ul><h4 id=å®ç°-epoll-æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“><a href=#å®ç°-epoll-æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“ class=anchor-link>#</a>å®ç° epoll æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“</h4><p>èƒ½å¤Ÿå…‹æœ select å‡½æ•°ç¼ºç‚¹çš„ epoll å‡½æ•°å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼Œè¿™äº›ä¼˜ç‚¹æ­£å¥½ä¸ä¹‹å‰çš„ select å‡½æ•°ç¼ºç‚¹ç›¸åã€‚</p><ul><li>æ— éœ€ç¼–å†™ä»¥ç›‘è§†çŠ¶æ€å˜åŒ–ä¸ºç›®çš„çš„é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯è¯­å¥</li><li>è°ƒç”¨å¯¹åº”äº select å‡½æ•°çš„ epoll_wait å‡½æ•°æ—¶æ— éœ€æ¯æ¬¡ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ã€‚</li></ul><p>ä¸‹é¢æ˜¯ epoll å‡½æ•°çš„åŠŸèƒ½ï¼š</p><ul><li>epoll_createï¼šåˆ›å»ºä¿å­˜ epoll æ–‡ä»¶æè¿°ç¬¦çš„ç©ºé—´</li><li>epoll_ctlï¼šå‘ç©ºé—´æ³¨å†Œå¹¶æ³¨é”€æ–‡ä»¶æè¿°ç¬¦</li><li>epoll_waitï¼šä¸ select å‡½æ•°ç±»ä¼¼ï¼Œç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿå˜åŒ–</li></ul><p>select å‡½æ•°ä¸­ä¸ºäº†ä¿å­˜ç›‘è§†å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç›´æ¥å£°æ˜äº† fd_set å˜é‡ï¼Œä½†epollæ–¹å¼è®©æ“ä½œç³»ç»Ÿè´Ÿè´£ä¿å­˜ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤éœ€è¦å‘æ“ä½œç³»ç»Ÿè¯·æ±‚åˆ›å»ºä¿å­˜æ–‡ä»¶æè¿°ç¬¦çš„ç©ºé—´ï¼Œæ­¤æ—¶ç”¨çš„å‡½æ•°å°±æ˜¯ epoll_create ã€‚<br>æ­¤å¤–ï¼Œä¸ºäº†<strong>æ·»åŠ å’Œåˆ é™¤ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œselect æ–¹å¼ä¸­éœ€è¦ FD_SETã€FD_CLR å‡½æ•°ã€‚ä½†åœ¨ epoll æ–¹å¼ä¸­ï¼Œ<strong>é€šè¿‡ epoll_ctl å‡½æ•°è¯·æ±‚æ“ä½œç³»ç»Ÿå®Œæˆ</strong>ã€‚æœ€åï¼Œselect æ–¹å¼ä¸‹è°ƒç”¨ select å‡½æ•°ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„å˜åŒ–ï¼Œè€Œ epoll_wait è°ƒç”¨ epoll_wait å‡½æ•°ã€‚è¿˜æœ‰ï¼Œselect æ–¹å¼ä¸­é€šè¿‡ fd_set å˜é‡æŸ¥çœ‹ç›‘è§†å¯¹è±¡çš„çŠ¶æ€å˜åŒ–ï¼Œè€Œ epoll æ–¹å¼é€šè¿‡å¦‚ä¸‹ç»“æ„ä½“ epoll_event å°†å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦å•ç‹¬é›†ä¸­åœ¨ä¸€èµ·ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>epoll_event</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__uint32_t</span> <span class=n>events</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>epoll_data_t</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>union</span> <span class=nc>epoll_data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>__uint32_t</span> <span class=n>u32</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>__uint64_t</span> <span class=n>u64</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>epoll_data_t</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>å£°æ˜è¶³å¤Ÿå¤§çš„ epoll_event ç»“æ„ä½“æ•°ç»„åï¼Œä¼ é€’ç»™ epoll_wait å‡½æ•°æ—¶ï¼Œå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯å°†è¢«å¡«å…¥æ•°ç»„ã€‚å› æ­¤ï¼Œæ— éœ€åƒ select å‡½æ•°é‚£æ ·é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå¾ªç¯ã€‚</p><h4 id=epoll_create><a href=#epoll_create class=anchor-link>#</a>epoll_create</h4><p>epoll æ˜¯ä» Linux çš„ 2.5.44 ç‰ˆå†…æ ¸å¼€å§‹å¼•å…¥çš„ã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ Linux å†…æ ¸ç‰ˆæœ¬ï¼ˆè€å¼æœºå­éœ€è¦æ£€æŸ¥ï¼‰ï¼š</p><blockquote><p>cat /proc/sys/kernel/osrelease</p></blockquote><p>epoll_create åŸå‹</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/epoll.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>epoll_create</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› epoll çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>sizeï¼šepoll å®ä¾‹çš„å¤§å°
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>è°ƒç”¨ epoll_create å‡½æ•°æ—¶åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦ä¿å­˜ç©ºé—´ç§°ä¸ºã€Œ<strong>epoll ä¾‹ç¨‹</strong>ã€ï¼Œä½†æœ‰äº›æƒ…å†µä¸‹åç§°ä¸åŒï¼Œéœ€è¦ç¨åŠ æ³¨æ„ã€‚é€šè¿‡å‚æ•° size ä¼ é€’çš„å€¼å†³å®š epoll ä¾‹ç¨‹çš„å¤§å°ï¼Œä½†è¯¥å€¼åªæ˜¯å‘æ“ä½œç³»ç»Ÿæå‡ºçš„å»ºè®®ã€‚æ¢è¨€ä¹‹ï¼Œsize å¹¶ä¸ç”¨æ¥å†³å®š epoll çš„å¤§å°ï¼Œè€Œä»…ä¾›æ“ä½œç³»ç»Ÿå‚è€ƒï¼ˆLinux3.6.8å<strong>å®Œå…¨å¿½ç•¥sizeå»ºè®®</strong>ï¼‰ã€‚<br>epoll_create å‡½æ•°åˆ›å»ºçš„èµ„æºä¸å¥—æ¥å­—ç›¸åŒï¼Œä¹Ÿç”±æ“ä½œç³»ç»Ÿç®¡ç†ã€‚å› æ­¤ï¼Œè¯¥å‡½æ•°å’Œåˆ›å»ºå¥—æ¥å­—çš„æƒ…å†µç›¸åŒï¼Œä¹Ÿä¼šè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ä¸»è¦ç”¨äºåŒºåˆ† epoll ä¾‹ç¨‹ã€‚éœ€è¦ç»ˆæ­¢æ—¶ï¼Œä¸å…¶ä»–æ–‡ä»¶æè¿°ç¬¦ç›¸åŒï¼Œä¹Ÿ<strong>è¦è°ƒç”¨ close å‡½æ•°ã€‚</strong></p><h4 id=epoll_ctl><a href=#epoll_ctl class=anchor-link>#</a>epoll_ctl</h4><p>ç”Ÿæˆä¾‹ç¨‹åï¼Œåº”åœ¨å…¶å†…éƒ¨æ³¨å†Œç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ï¼Œæ­¤æ—¶ä½¿ç”¨ epoll_ctl å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/epoll.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>epoll_ctl</span><span class=p>(</span><span class=kt>int</span> <span class=n>epfd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>op</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>epoll_event</span> <span class=o>*</span><span class=n>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>epfdï¼šç”¨äºæ³¨å†Œç›‘è§†å¯¹è±¡çš„ epoll ä¾‹ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>opï¼šç”¨äºæŒ‡å®šç›‘è§†å¯¹è±¡çš„æ·»åŠ ã€åˆ é™¤æˆ–æ›´æ”¹ç­‰æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=cm>fdï¼šéœ€è¦æ³¨å†Œçš„ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>eventï¼šç›‘è§†å¯¹è±¡çš„äº‹ä»¶ç±»å‹
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>op:
</span></span></span><span class=line><span class=cl><span class=cm>EPOLL_CTL_ADDï¼šå°†æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° epoll ä¾‹ç¨‹
</span></span></span><span class=line><span class=cl><span class=cm>EPOLL_CTL_DELï¼šä» epoll ä¾‹ç¨‹ä¸­åˆ é™¤æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>EPOLL_CTL_MODï¼šæ›´æ”¹æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦çš„å…³æ³¨äº‹ä»¶å‘ç”Ÿæƒ…å†µ
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä¸å…¶ä»– epoll å‡½æ•°ç›¸æ¯”ï¼Œè¯¥å‡½æ•°çœ‹èµ·æ¥æœ‰äº›å¤æ‚ï¼Œä½†é€šè¿‡è°ƒç”¨è¯­å¥å°±å¾ˆå®¹æ˜“ç†è§£ï¼Œå‡è®¾æŒ‰ç…§å¦‚ä¸‹å½¢å¼è°ƒç”¨ epoll_ctl å‡½æ•°ï¼š</p><blockquote><p>epoll_ctl(A,EPOLL_CTL_ADD,B,C);
epoll ä¾‹ç¨‹ A ä¸­<strong>æ³¨å†Œ</strong>æ–‡ä»¶æè¿°ç¬¦ B ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç›‘è§†å‚æ•° C ä¸­çš„äº‹ä»¶</p></blockquote><blockquote><p>epoll_ctl(A,EPOLL_CTL_DEL,B,NULL);
ä» epoll ä¾‹ç¨‹ A ä¸­åˆ é™¤æ–‡ä»¶æè¿°ç¬¦ B</p></blockquote><p>epoll_event ç»“æ„ä½“ç”¨äºå’Œä¿å­˜äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ç»“åˆã€‚ä½†ä¹Ÿå¯ä»¥åœ¨ epoll_ctlä¸­æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œç”¨äºæ³¨å†Œå…³æ³¨çš„äº‹ä»¶ã€‚è¯¥å‡½æ•°ä¸­ epoll_event ç»“æ„ä½“çš„å®šä¹‰å¹¶ä¸æ˜¾çœ¼ï¼Œå› æ­¤é€šè¿‡è°ƒç”¨è¯­å¥è¯´æ˜è¯¥ç»“æ„ä½“åœ¨ epoll_ctl å‡½æ•°ä¸­çš„åº”ç”¨ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>epoll_event</span> <span class=n>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>event</span><span class=p>.</span><span class=n>events</span><span class=o>=</span><span class=n>EPOLLIN</span><span class=p>;</span><span class=c1>//å‘ç”Ÿéœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µæ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>event</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=o>=</span><span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span><span class=n>EPOLL_CTL_ADD</span><span class=p>,</span><span class=n>sockfd</span><span class=p>,</span><span class=o>&amp;</span><span class=n>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä¸Šè¿°ä»£ç å°† sockfd æ³¨å†Œåˆ° epoll ä¾‹ç¨‹ epfd ä¸­ï¼Œå¹¶åœ¨éœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µä¸‹äº§ç”Ÿç›¸åº”äº‹ä»¶ã€‚æ¥ä¸‹æ¥ç»™å‡º epoll_event çš„æˆå‘˜ events ä¸­å¯ä»¥ä¿å­˜çš„å¸¸é‡åŠæ‰€æŒ‡çš„äº‹ä»¶ç±»å‹ã€‚</p><ul><li>EPOLLINï¼šéœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µ</li><li>EPOLLOUTï¼šè¾“å‡ºç¼“å†²ä¸ºç©ºï¼Œå¯ä»¥ç«‹å³å‘é€æ•°æ®çš„æƒ…å†µ</li><li>EPOLLPRIï¼šæ”¶åˆ° OOB æ•°æ®çš„æƒ…å†µ</li><li>EPOLLRDHUPï¼šæ–­å¼€è¿æ¥æˆ–åŠå…³é—­çš„æƒ…å†µï¼Œè¿™åœ¨è¾¹ç¼˜è§¦å‘æ–¹å¼ä¸‹éå¸¸æœ‰ç”¨</li><li>EPOLLERRï¼šå‘ç”Ÿé”™è¯¯çš„æƒ…å†µ</li><li>EPOLLETï¼šä»¥è¾¹ç¼˜è§¦å‘çš„æ–¹å¼å¾—åˆ°äº‹ä»¶é€šçŸ¥</li><li>EPOLLONESHOTï¼šå‘ç”Ÿä¸€æ¬¡äº‹ä»¶åï¼Œç›¸åº”æ–‡ä»¶æè¿°ç¬¦ä¸å†æ”¶åˆ°äº‹ä»¶é€šçŸ¥ã€‚å› æ­¤éœ€è¦å‘ epoll_ctl å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ EPOLL_CTL_MOD ï¼Œå†æ¬¡è®¾ç½®äº‹ä»¶ã€‚</li></ul><p>å¯é€šè¿‡ä½æˆ–è¿ç®— | åŒæ—¶ä¼ é€’å¤šä¸ªä¸Šè¿°å‚æ•°ã€‚</p><h4 id=epoll_wait><a href=#epoll_wait class=anchor-link>#</a>epoll_wait</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/epoll.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>epoll_wait</span><span class=p>(</span><span class=kt>int</span> <span class=n>epfd</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>epoll_event</span> <span class=o>*</span><span class=n>events</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxevents</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å›å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>epfd : è¡¨ç¤ºäº‹ä»¶å‘ç”Ÿç›‘è§†èŒƒå›´çš„ epoll ä¾‹ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>events : ä¿å­˜å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„ç»“æ„ä½“åœ°å€å€¼
</span></span></span><span class=line><span class=cl><span class=cm>maxevents : ç¬¬äºŒä¸ªå‚æ•°ä¸­å¯ä»¥ä¿å­˜çš„æœ€å¤§äº‹ä»¶æ•°
</span></span></span><span class=line><span class=cl><span class=cm>timeout : ä»¥ 1/1000 ç§’ä¸ºå•ä½çš„ç­‰å¾…æ—¶é—´ï¼Œä¼ é€’ -1 æ—¶ï¼Œä¸€ç›´ç­‰å¾…ç›´åˆ°å‘ç”Ÿäº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>è¯¥å‡½æ•°è°ƒç”¨æ–¹å¼å¦‚ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬äºŒä¸ªå‚æ•°æ‰€æŒ‡ç¼“å†²éœ€è¦åŠ¨æ€åˆ†é…ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>event_cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>epoll_event</span> <span class=o>*</span><span class=n>ep_events</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>ep_events</span><span class=o>=</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>epoll_event</span><span class=p>)</span><span class=o>*</span><span class=n>EPOLL_SIZE</span><span class=p>);</span><span class=c1>//EPOLL_SIZEæ˜¯å®å¸¸é‡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>event_cnt</span><span class=o>=</span><span class=n>epoll_wait</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span><span class=n>ep_events</span><span class=p>,</span><span class=n>EPOLL_SIZE</span><span class=p>,</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div></div><p>è°ƒç”¨å‡½æ•°åï¼Œè¿”å›å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ï¼ŒåŒæ—¶åœ¨ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘çš„ç¼“å†²ä¸­ä¿å­˜å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚å› æ­¤ï¼Œæ— éœ€åƒ select ä¸€æ ·æ’å…¥é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯ã€‚</p><h4 id=åŸºäº-epoll-çš„å›å£°æœåŠ¡å™¨ç«¯><a href=#åŸºäº-epoll-çš„å›å£°æœåŠ¡å™¨ç«¯ class=anchor-link>#</a>åŸºäº epoll çš„å›å£°æœåŠ¡å™¨ç«¯</h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define EPOLL_SIZE 100
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>struct</span> <span class=nc>epoll_event</span> <span class=o>*</span><span class=n>ep_events</span><span class=p>;</span> <span class=c1>// ç”¨æŒ‡é’ˆå¯ä»¥å­˜å‚¨å¤šä¸ªevent
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>epoll_event</span> <span class=n>event</span><span class=p>;</span>   <span class=c1>// å•ä¸ªeventç”¨äºæŒ‡æ˜äº‹ä»¶ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>epfd</span> <span class=o>=</span> <span class=n>epoll_create</span><span class=p>(</span><span class=n>EPOLL_SIZE</span><span class=p>);</span> <span class=c1>//å¯ä»¥å¿½ç•¥è¿™ä¸ªå‚æ•°ï¼Œå¡«å…¥çš„å‚æ•°ä¸ºæ“ä½œç³»ç»Ÿå‚è€ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ep_events</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>epoll_event</span><span class=p>)</span> <span class=o>*</span> <span class=n>EPOLL_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>event</span><span class=p>.</span><span class=n>events</span> <span class=o>=</span> <span class=n>EPOLLIN</span><span class=p>;</span> <span class=c1>//éœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>event</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span> <span class=o>=</span> <span class=n>serv_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span> <span class=n>EPOLL_CTL_ADD</span><span class=p>,</span> <span class=n>serv_sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>event</span><span class=p>);</span> <span class=c1>//ä¾‹ç¨‹epfd ä¸­æ·»åŠ æ–‡ä»¶æè¿°ç¬¦ serv_sockï¼Œç›®çš„æ˜¯ç›‘å¬ enevt ä¸­çš„äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>event_cnt</span> <span class=o>=</span> <span class=n>epoll_wait</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span> <span class=n>ep_events</span><span class=p>,</span> <span class=n>EPOLL_SIZE</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span> <span class=c1>//è·å–æ”¹å˜äº†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿”å›æ•°é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>event_cnt</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>puts</span><span class=p>(</span><span class=s>&#34;epoll_wait() error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>event_cnt</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>  <span class=c1>// å¾ªç¯æ¬¡æ•°å˜å°‘ï¼Œåªæœ‰å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ep_events</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span> <span class=o>==</span> <span class=n>serv_sock</span><span class=p>)</span> <span class=c1>//å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥æ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>adr_sz</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>clnt_adr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//  (struct sockaddr *)&amp;clnt_sock  å¯ä»¥è¿æ¥ä¸Šç¬¬ä¸€æ¬¡ä½†æ˜¯ä¸‹ä¸€æ¬¡å°±é‡å¤å¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>clnt_sock</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clnt_adr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>adr_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=p>.</span><span class=n>events</span> <span class=o>=</span> <span class=n>EPOLLIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span> <span class=o>=</span> <span class=n>clnt_sock</span><span class=p>;</span> <span class=c1>//æŠŠå®¢æˆ·ç«¯å¥—æ¥å­—æ·»åŠ è¿›å»
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span> <span class=n>EPOLL_CTL_ADD</span><span class=p>,</span> <span class=n>clnt_sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>printf</span><span class=p>(</span><span class=s>&#34;connected client : %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>clnt_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=c1>//æ˜¯å®¢æˆ·ç«¯å¥—æ¥å­—æ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>str_len</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>ep_events</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>str_len</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span> <span class=n>EPOLL_CTL_DEL</span><span class=p>,</span> <span class=n>ep_events</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span> <span class=c1>//ä»epollä¸­åˆ é™¤å¥—æ¥å­—
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>close</span><span class=p>(</span><span class=n>ep_events</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;closed client : %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ep_events</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>write</span><span class=p>(</span><span class=n>ep_events</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>str_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>close</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>close</span><span class=p>(</span><span class=n>epfd</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>æ€»ç»“ä¸€ä¸‹ epoll çš„æµç¨‹ï¼š</p><ol><li>epoll_create åˆ›å»ºä¸€ä¸ªä¿å­˜ epoll æ–‡ä»¶æè¿°ç¬¦çš„ç©ºé—´ï¼Œå¯ä»¥æ²¡æœ‰å‚æ•°</li><li>åŠ¨æ€åˆ†é…å†…å­˜ï¼Œç»™å°†è¦ç›‘è§†çš„ epoll_wait</li><li>åˆ©ç”¨ epoll_ctl æ§åˆ¶ æ·»åŠ  åˆ é™¤ï¼Œç›‘å¬äº‹ä»¶</li><li>åˆ©ç”¨ epoll_wait æ¥è·å–æ”¹å˜çš„æ–‡ä»¶æè¿°ç¬¦,æ¥æ‰§è¡Œç¨‹åº</li></ol><p>select å’Œ epoll çš„åŒºåˆ«ï¼š</p><ul><li>æ¯æ¬¡è°ƒç”¨ select å‡½æ•°éƒ½ä¼šå‘æ“ä½œç³»ç»Ÿä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ï¼Œæµªè´¹å¤§é‡æ—¶é—´</li><li>epoll ä»…å‘æ“ä½œç³»ç»Ÿä¼ é€’ä¸€æ¬¡ç›‘è§†å¯¹è±¡ï¼Œç›‘è§†èŒƒå›´æˆ–å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶åªé€šçŸ¥å‘ç”Ÿå˜åŒ–çš„äº‹é¡¹</li></ul><h3 id=æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘><a href=#æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ class=anchor-link>#</a>æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘</h3><p><strong>æ¡ä»¶è§¦å‘çš„ç‰¹æ€§</strong>(epollé»˜è®¤)ï¼š</p><blockquote><p>æ¡ä»¶è§¦å‘æ–¹å¼ä¸­ï¼Œåªè¦è¾“å…¥ç¼“å†²ä¸€æœ‰æ•°æ®å°±ä¼šä¸€ç›´é€šçŸ¥è¯¥äº‹ä»¶</p></blockquote><p><strong>è¾¹ç¼˜è§¦å‘ç‰¹æ€§</strong>ï¼š</p><blockquote><p>è¾¹ç¼˜è§¦å‘ä¸­è¾“å…¥ç¼“å†²æ”¶åˆ°æ•°æ®æ—¶ä»…æ³¨å†Œï¼ˆé€šçŸ¥ï¼‰ 1 æ¬¡è¯¥äº‹ä»¶ã€‚å³ä½¿è¾“å…¥ç¼“å†²ä¸­è¿˜ç•™æœ‰æ•°æ®ï¼Œä¹Ÿä¸ä¼šå†è¿›è¡Œæ³¨å†Œã€‚</p></blockquote><p>æ²¡çœ‹æ‡‚<a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch17/echo_EDGEserv.c target=_blank rel=noopener>ä»£ç </a>ï¼Œæœ‰æ—¶å€™é‡å¤è¿æ¥æˆ–è€…æ²¡æ¥æ”¶å®Œå®¢æˆ·ç«¯æ•°æ®å°±ç«‹é©¬åœæ­¢æœåŠ¡ç«¯</p><h4 id=è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹><a href=#è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹ class=anchor-link>#</a>è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹</h4><ul><li>é€šè¿‡ errno å˜é‡éªŒè¯é”™è¯¯åŸå› </li><li>ä¸ºäº†å®Œæˆéé˜»å¡ï¼ˆNon-blockingï¼‰I/O ï¼Œæ›´æ”¹äº†å¥—æ¥å­—ç‰¹æ€§ã€‚</li></ul><p>Linux å¥—æ¥å­—ç›¸å…³å‡½æ•°ä¸€èˆ¬é€šè¿‡ -1 é€šçŸ¥å‘ç”Ÿäº†é”™è¯¯ã€‚è™½ç„¶çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†ä»…å‡­è¿™äº›å†…å®¹æ— æ³•å¾—çŸ¥äº§ç”Ÿé”™è¯¯çš„åŸå› ã€‚å› æ­¤ï¼Œä¸ºäº†åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™æä¾›é¢å¤–çš„ä¿¡æ¯ï¼ŒLinux å£°æ˜äº†å¦‚ä¸‹å…¨å±€å˜é‡ï¼š</p><blockquote><p>int errno;</p></blockquote><p>ä¸ºäº†è®¿é—®è¯¥å˜é‡ï¼Œéœ€è¦å¼•å…¥ error.h å¤´æ–‡ä»¶ã€‚å¦å¤–ï¼Œæ¯ç§å‡½æ•°å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä¿å­˜åœ¨ errno å˜é‡ä¸­çš„å€¼éƒ½ä¸åŒã€‚</p><blockquote><p>read å‡½æ•°å‘ç°è¾“å…¥ç¼“å†²ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è¿”å› -1ï¼ŒåŒæ—¶åœ¨ errno ä¸­ä¿å­˜ EAGAIN å¸¸é‡</p></blockquote><h4 id=æ”¹å˜æ–‡ä»¶å±æ€§><a href=#æ”¹å˜æ–‡ä»¶å±æ€§ class=anchor-link>#</a>æ”¹å˜æ–‡ä»¶å±æ€§</h4><p>ä¸‹é¢æ˜¯ Linux ä¸­æä¾›çš„æ”¹å˜å’Œæ›´æ”¹æ–‡ä»¶å±æ€§çš„åŠæ³•ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>fcntl</span><span class=p>(</span><span class=kt>int</span> <span class=n>fields</span><span class=p>,</span> <span class=kt>int</span> <span class=n>cmd</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› cmd å‚æ•°ç›¸å…³å€¼ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>filedes : å±æ€§æ›´æ”¹ç›®æ ‡çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=cm>cmd : è¡¨ç¤ºå‡½æ•°è°ƒç”¨ç›®çš„
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä»ä¸Šè¿°å£°æ˜å¯ä»¥çœ‹å‡º fcntl æœ‰å¯å˜å‚æ•°çš„å½¢å¼ã€‚å¦‚æœå‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ F_GETFL ï¼Œå¯ä»¥è·å¾—ç¬¬ä¸€ä¸ªå‚æ•°æ‰€æŒ‡çš„æ–‡ä»¶æè¿°ç¬¦å±æ€§ï¼ˆint å‹ï¼‰ã€‚åä¹‹ï¼Œå¦‚æœä¼ é€’ F_SETFL ï¼Œå¯ä»¥æ›´æ”¹æ–‡ä»¶æè¿°ç¬¦å±æ€§ã€‚è‹¥å¸Œæœ›å°†å¥—æ¥å­—æ”¹ä¸ºéé˜»å¡æ¨¡å¼ï¼Œéœ€è¦å¦‚ä¸‹ 2 æ¡è¯­å¥ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>flag</span> <span class=o>=</span> <span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=n>F_GETFL</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>flag</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div></div><p>é€šè¿‡ç¬¬ä¸€æ¡è¯­å¥ï¼Œè·å–ä¹‹å‰è®¾ç½®çš„å±æ€§ä¿¡æ¯ï¼Œé€šè¿‡ç¬¬äºŒæ¡è¯­å¥åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ éé˜»å¡ O_NONBLOCK æ ‡å¿—ã€‚è°ƒç”¨ read/write å‡½æ•°æ—¶ï¼Œæ— è®ºæ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œéƒ½ä¼šå½¢æˆéé˜»å¡æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¥—æ¥å­—ï¼‰ã€‚fcntl å‡½æ•°çš„é€‚ç”¨èŒƒå›´å¾ˆå¹¿ã€‚</p><h4 id=å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯><a href=#å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯ class=anchor-link>#</a>å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯</h4><p>é€šè¿‡ errno ç¡®è®¤é”™è¯¯çš„åŸå› æ˜¯ï¼šè¾¹ç¼˜è§¦å‘æ–¹å¼ä¸­ï¼Œæ¥æ”¶æ•°æ®ä»…æ³¨å†Œä¸€æ¬¡è¯¥äº‹ä»¶ã€‚<br>å› ä¸ºè¿™ç§ç‰¹ç‚¹ï¼Œä¸€æ—¦å‘ç”Ÿè¾“å…¥ç›¸å…³äº‹ä»¶æ—¶ï¼Œå°±åº”è¯¥è¯»å–è¾“å…¥ç¼“å†²ä¸­çš„å…¨éƒ¨æ•°æ®ã€‚å› æ­¤éœ€è¦éªŒè¯è¾“å…¥ç¼“å†²æ˜¯å¦ä¸ºç©ºã€‚</p><blockquote><p>read å‡½æ•°è¿”å› -1ï¼Œå˜é‡ errno ä¸­çš„å€¼å˜æˆ EAGAIN æ—¶ï¼Œè¯´æ˜æ²¡æœ‰æ•°æ®å¯è¯»ã€‚</p></blockquote><p>æ—¢ç„¶å¦‚æ­¤ï¼Œä¸ºä»€ä¹ˆè¦å°†å¥—æ¥å­—å˜æˆéé˜»å¡æ¨¡å¼ï¼Ÿè¾¹ç¼˜è§¦å‘æ¡ä»¶ä¸‹ï¼Œä»¥é˜»å¡æ–¹å¼å·¥ä½œçš„ read & write å‡½æ•°æœ‰å¯èƒ½å¼•èµ·æœåŠ¡ç«¯çš„é•¿æ—¶é—´åœé¡¿ã€‚å› æ­¤ï¼Œè¾¹ç¼˜è§¦å‘æ–¹å¼ä¸­ä¸€å®šè¦é‡‡ç”¨éé˜»å¡ read & write å‡½æ•°ã€‚<br>è¿˜æ˜¯çœ‹ä¸æ‡‚ï¼Œä»¥åå†è€ƒè™‘è¾¹ç¼˜è§¦å‘ã€‚</p><h4 id=æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£><a href=#æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£ class=anchor-link>#</a>æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£</h4><p>è¾¹ç¼˜è§¦å‘æ–¹å¼å¯ä»¥åšåˆ°è¿™ç‚¹ï¼š</p><blockquote><p>å¯ä»¥åˆ†ç¦»æ¥æ”¶æ•°æ®å’Œå¤„ç†æ•°æ®çš„æ—¶é—´ç‚¹ï¼</p></blockquote><p>ä¸‹é¢æ˜¯è¾¹ç¼˜è§¦å‘çš„å›¾<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-14.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-14.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=WmjF3&amp;originHeight=303&amp;originWidth=377&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æœåŠ¡å™¨ç«¯åˆ†åˆ«ä» A B C æ¥æ”¶æ•°æ®</li><li>æœåŠ¡å™¨ç«¯æŒ‰ç…§ A B C çš„é¡ºåºé‡æ–°ç»„åˆæ¥æ”¶åˆ°çš„æ•°æ®</li><li>ç»„åˆçš„æ•°æ®å°†å‘é€ç»™ä»»æ„ä¸»æœºã€‚</li></ul><p>ä¸ºäº†å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œå¦‚æœå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æµç¨‹è¿è¡Œï¼ŒæœåŠ¡ç«¯çš„å®ç°å¹¶ä¸éš¾ï¼š</p><ul><li>å®¢æˆ·ç«¯æŒ‰ç…§ A B C çš„é¡ºåºè¿æ¥æœåŠ¡å™¨ï¼Œå¹¶ä¸”æŒ‰ç…§æ¬¡åºå‘æœåŠ¡å™¨å‘é€æ•°æ®</li><li>éœ€è¦æ¥æ”¶æ•°æ®çš„å®¢æˆ·ç«¯åº”åœ¨å®¢æˆ·ç«¯ A B C ä¹‹å‰è¿æ¥åˆ°æœåŠ¡å™¨ç«¯å¹¶ç­‰å¾…</li></ul><p>ä½†æ˜¯å®é™…æƒ…å†µä¸­å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p><ul><li>å®¢æˆ·ç«¯ C å’Œ B æ­£åœ¨å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œä½†æ˜¯ A å¹¶æ²¡æœ‰è¿æ¥åˆ°æœåŠ¡å™¨</li><li>å®¢æˆ·ç«¯ A B C ä¹±åºå‘é€æ•°æ®</li><li>æœåŠ¡ç«¯å·²ç»æ¥æ”¶åˆ°æ•°æ®ï¼Œä½†æ˜¯è¦æ¥æ”¶æ•°æ®çš„ç›®æ ‡å®¢æˆ·ç«¯å¹¶æ²¡æœ‰è¿æ¥åˆ°æœåŠ¡å™¨ç«¯ã€‚</li></ul><p>å› æ­¤ï¼Œä½¿ç”¨è¾¹ç¼˜è§¦å‘ï¼Œå³ä½¿è¾“å…¥ç¼“å†²æ”¶åˆ°æ•°æ®ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿèƒ½å†³å®šè¯»å–å’Œå¤„ç†è¿™äº›æ•°æ®çš„æ—¶é—´ç‚¹ï¼Œè¿™æ ·å°±ç»™æœåŠ¡å™¨ç«¯çš„å®ç°å¸¦æ¥å¾ˆå¤§çµæ´»æ€§ã€‚</p><h2 id=å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°><a href=#å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç° class=anchor-link>#</a>å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°</h2><h3 id=ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ><a href=#ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ class=anchor-link>#</a>ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ</h3><p>å¤šè¿›ç¨‹çš„ç¼ºç‚¹å¯æ¦‚æ‹¬ä¸ºï¼š</p><ul><li>åˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€</li><li>ä¸ºäº†å®Œæˆè¿›ç¨‹é—´æ•°æ®äº¤æ¢ï¼Œéœ€è¦ç‰¹æ®Šçš„ IPC æŠ€æœ¯ã€‚</li><li><strong>æ¯ç§’å°‘åˆ™ 10 æ¬¡ï¼Œå¤šåˆ™åƒæ¬¡çš„ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ˜¯åˆ›å»ºè¿›ç¨‹çš„æœ€å¤§å¼€é”€</strong></li></ul><p>çº¿ç¨‹æ¯”è¿›ç¨‹å…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>çº¿ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¿›ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢<strong>æ›´å¿«ï¼ˆä¸æ˜¯æ¶ˆé™¤ï¼‰</strong></li><li>çº¿ç¨‹é—´äº¤æ¢æ•°æ®æ— éœ€ç‰¹æ®ŠæŠ€æœ¯ï¼ˆè¿›ç¨‹pipeï¼‰</li></ul><h4 id=çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚><a href=#çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚ class=anchor-link>#</a>çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚</h4><p>çº¿ç¨‹æ˜¯ä¸ºäº†è§£å†³ï¼šä¸ºäº†å¾—åˆ°å¤šæ¡ä»£ç æ‰§è¡Œæµè€Œå¤åˆ¶æ•´ä¸ªå†…å­˜åŒºåŸŸçš„è´Ÿæ‹…å¤ªé‡ã€‚<br>æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´éƒ½ç”±ä¿å­˜å…¨å±€å˜é‡çš„ã€Œæ•°æ®åŒºã€ã€å‘ malloc ç­‰å‡½æ•°åŠ¨æ€åˆ†é…æä¾›ç©ºé—´çš„å †ï¼ˆHeapï¼‰ã€å‡½æ•°è¿è¡Œæ—¶ä½¿ç”¨çš„æ ˆï¼ˆStackï¼‰æ„æˆã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„è¿™ç§ç©ºé—´ï¼Œå¤šä¸ªè¿›ç¨‹çš„å†…å­˜ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-15.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-15.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=fc3E9&amp;originHeight=270&amp;originWidth=404&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>ä½†å¦‚æœä»¥è·å¾—å¤šä¸ªä»£ç æ‰§è¡Œæµä¸ºç›®çš„ï¼Œåˆ™ä¸åº”è¯¥åƒä¸Šå›¾é‚£æ ·å®Œå…¨åˆ†ç¦»å†…å­˜ç»“æ„ï¼Œè€Œåªéœ€åˆ†ç¦»æ ˆåŒºåŸŸã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥è·å¾—å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ä¸éœ€è¦åˆ‡æ¢æ•°æ®åŒºå’Œå †</li><li>å¯ä»¥åˆ©ç”¨æ•°æ®åŒºå’Œå †äº¤æ¢æ•°æ®</li></ul><p>å®é™…ä¸Šè¿™å°±æ˜¯çº¿ç¨‹ã€‚çº¿ç¨‹ä¸ºäº†ä¿æŒå¤šæ¡ä»£ç æ‰§è¡Œæµè€Œéš”å¼€äº†æ ˆåŒºåŸŸï¼Œå› æ­¤å…·æœ‰å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å†…å­˜ç»“æ„ï¼š<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-16.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-16.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=YP0bE&amp;originHeight=327&amp;originWidth=311&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>å¦‚å›¾æ‰€ç¤ºï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«æ•°æ®åŒºå’Œå †ã€‚ä¸ºäº†ä¿æŒè¿™ç§ç»“æ„ï¼Œçº¿ç¨‹å°†åœ¨è¿›ç¨‹å†…åˆ›å»ºå¹¶è¿è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹å¯ä»¥å®šä¹‰ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><ul><li>è¿›ç¨‹ï¼šåœ¨æ“ä½œç³»ç»Ÿæ„æˆå•ç‹¬æ‰§è¡Œæµçš„å•ä½</li><li>çº¿ç¨‹ï¼šåœ¨è¿›ç¨‹æ„æˆå•ç‹¬æ‰§è¡Œæµçš„å•ä½</li></ul><p>å¦‚æœè¯´è¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨ç”Ÿæˆå¤šä¸ªæ‰§è¡Œæµï¼Œé‚£ä¹ˆçº¿ç¨‹å°±åœ¨åŒä¸€è¿›ç¨‹å†…éƒ¨åˆ›å»ºå¤šæ¡æ‰§è¡Œæµã€‚å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿã€è¿›ç¨‹ã€çº¿ç¨‹ä¹‹é—´çš„å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºä¸‹å›¾ï¼š<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-17.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-17.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=ZsCJA&amp;originHeight=223&amp;originWidth=343&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a></p><h3 id=çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ><a href=#çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ class=anchor-link>#</a>çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ</h3><h4 id=posixçš„ç”±æ¥><a href=#posixçš„ç”±æ¥ class=anchor-link>#</a>posixçš„ç”±æ¥</h4><p>å¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼ˆè‹±è¯­ï¼šPortable Operating System Interfaceï¼Œç¼©å†™ä¸ºPOSIXï¼‰æ˜¯IEEEä¸ºè¦åœ¨å„ç§UNIXæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œè½¯ä»¶ï¼Œè€Œå®šä¹‰APIçš„ä¸€ç³»åˆ—äº’ç›¸å…³è”çš„æ ‡å‡†çš„æ€»ç§°ï¼Œå…¶æ­£å¼ç§°å‘¼ä¸ºIEEE Std 1003ï¼Œè€Œå›½é™…æ ‡å‡†åç§°ä¸ºISO/IEC 9945ã€‚æ­¤æ ‡å‡†æºäºä¸€ä¸ªå¤§çº¦å¼€å§‹äº1985å¹´çš„é¡¹ç›®ã€‚POSIXè¿™ä¸ªåç§°æ˜¯ç”±ç†æŸ¥å¾·Â·æ–¯æ‰˜æ›¼ï¼ˆRMSï¼‰åº”IEEEçš„è¦æ±‚è€Œæè®®çš„ä¸€ä¸ªæ˜“äºè®°å¿†çš„åç§°ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯Portable Operating System Interfaceï¼ˆå¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼‰çš„ç¼©å†™ï¼Œè€ŒXåˆ™è¡¨æ˜å…¶å¯¹Unix APIçš„ä¼ æ‰¿ã€‚<br>LinuxåŸºæœ¬ä¸Šé€æ­¥å®ç°äº†POSIXå…¼å®¹ï¼Œä½†å¹¶æ²¡æœ‰å‚åŠ æ­£å¼çš„POSIXè®¤è¯ã€‚<br>å¾®è½¯çš„Windows NTå£°ç§°éƒ¨åˆ†å®ç°äº†POSIXæ ‡å‡†ã€‚<br>å½“å‰çš„POSIXä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼šBase Definitionsã€System Interfacesã€Shell and Utilitieså’ŒRationaleã€‚</p><h4 id=çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹><a href=#çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹ class=anchor-link>#</a>çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹</h4><p>çº¿ç¨‹å…·æœ‰å•ç‹¬çš„æ‰§è¡Œæµï¼Œå› æ­¤éœ€è¦å•ç‹¬å®šä¹‰çº¿ç¨‹çš„ main å‡½æ•°ï¼Œè¿˜éœ€è¦è¯·æ±‚æ“ä½œç³»ç»Ÿåœ¨å•ç‹¬çš„æ‰§è¡Œæµä¸­æ‰§è¡Œè¯¥å‡½æ•°ï¼Œå®Œæˆå‡½æ•°åŠŸèƒ½çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>pthread_create</span><span class=p>(</span><span class=n>pthread_t</span> <span class=o>*</span><span class=k>restrict</span> <span class=kr>thread</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=k>const</span> <span class=n>pthread_attr_t</span> <span class=o>*</span><span class=k>restrict</span> <span class=n>attr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=kt>void</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>start_routine</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                   <span class=kt>void</span> <span class=o>*</span><span class=k>restrict</span> <span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>thread : ä¿å­˜æ–°åˆ›å»ºçº¿ç¨‹ ID çš„å˜é‡åœ°å€å€¼ã€‚çº¿ç¨‹ä¸è¿›ç¨‹ç›¸åŒï¼Œä¹Ÿéœ€è¦ç”¨äºåŒºåˆ†ä¸åŒçº¿ç¨‹çš„ ID
</span></span></span><span class=line><span class=cl><span class=cm>attr : ç”¨äºä¼ é€’çº¿ç¨‹å±æ€§çš„å‚æ•°ï¼Œä¼ é€’ NULL æ—¶ï¼Œåˆ›å»ºé»˜è®¤å±æ€§çš„çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=cm>start_routine : ç›¸å½“äºçº¿ç¨‹ main å‡½æ•°çš„ã€åœ¨å•ç‹¬æ‰§è¡Œæµä¸­æ‰§è¡Œçš„å‡½æ•°åœ°å€å€¼ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>arg : é€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’çš„è°ƒç”¨å‡½æ•°æ—¶åŒ…å«ä¼ é€’å‚æ•°ä¿¡æ¯çš„å˜é‡åœ°å€å€¼
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread1.c target=_blank rel=noopener>thread1.c</a></li><li><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-18.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></li><li>å¦‚æœä¸»è¿›æ²¡æœ‰ç­‰å¾…åç§’ï¼Œè€Œæ˜¯ç›´æ¥ç»“æŸï¼Œè¿™æ ·ä¹Ÿä¼šå¼ºåˆ¶ç»“æŸçº¿ç¨‹ï¼Œä¸è®ºçº¿ç¨‹æœ‰æ²¡æœ‰è¿è¡Œå®Œæ¯•ã€‚</li></ul><p>è°ƒç”¨è¯¥å‡½æ•°çš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰å°†è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ä¸º ID çš„çº¿ç¨‹ç»ˆæ­¢ä¸ºæ­¢ã€‚è€Œä¸”å¯ä»¥å¾—åˆ°çº¿ç¨‹çš„** main å‡½æ•°çš„è¿”å›å€¼**ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>pthread_join</span><span class=p>(</span><span class=n>pthread_t</span> <span class=kr>thread</span><span class=p>,</span> <span class=kt>void</span> <span class=o>**</span><span class=n>status</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class=line><span class=cl><span class=cm>thread : è¯¥å‚æ•°å€¼ ID çš„çº¿ç¨‹ç»ˆæ­¢åæ‰ä¼šä»è¯¥å‡½æ•°è¿”å›
</span></span></span><span class=line><span class=cl><span class=cm>status : ä¿å­˜çº¿ç¨‹çš„ main å‡½æ•°è¿”å›å€¼çš„æŒ‡é’ˆçš„å˜é‡åœ°å€å€¼
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread2.c target=_blank rel=noopener>thread2.c</a></li><li><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-19.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></li></ul><h4 id=å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°><a href=#å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•° class=anchor-link>#</a>å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°</h4><p>åœ¨åŒæ­¥çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œä¸´ç•ŒåŒºå—ï¼ˆCritical sectionï¼‰æŒ‡çš„æ˜¯ä¸€ä¸ªè®¿é—®å…±äº«èµ„æºï¼ˆä¾‹å¦‚ï¼šå…±äº«è®¾å¤‡æˆ–æ˜¯å…±äº«å­˜å‚¨å™¨ï¼‰çš„ç¨‹åºç‰‡æ®µï¼Œè€Œè¿™äº›å…±äº«èµ„æºæœ‰<strong>æ— æ³•åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®</strong>çš„ç‰¹æ€§ã€‚<br>æ ¹æ®ä¸´ç•ŒåŒºæ˜¯å¦å¼•èµ·é—®é¢˜ï¼Œå‡½æ•°å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 2 ç±»ï¼š</p><ul><li>çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼ˆThread-safe functionï¼‰</li><li>éçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼ˆThread-unsafe functionï¼‰</li></ul><p>çº¿ç¨‹å®‰å…¨å‡½æ•°è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ä¹Ÿä¸ä¼šå‘ç”Ÿé—®é¢˜ã€‚åä¹‹ï¼Œéçº¿ç¨‹å®‰å…¨å‡½æ•°è¢«åŒæ—¶è°ƒç”¨æ—¶ä¼šå¼•å‘é—®é¢˜ã€‚ä½†è¿™å¹¶éæœ‰å…³äºä¸´ç•ŒåŒºçš„è®¨è®ºï¼Œçº¿ç¨‹å®‰å…¨çš„å‡½æ•°ä¸­åŒæ ·å¯èƒ½å­˜åœ¨ä¸´ç•ŒåŒºã€‚åªæ˜¯åœ¨çº¿ç¨‹å®‰å…¨çš„å‡½æ•°ä¸­ï¼ŒåŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨æ—¶å¯é€šè¿‡ä¸€äº›æªæ–½é¿å…é—®é¢˜ã€‚<br>çº¿ç¨‹å®‰å…¨å‡½æ•°ç»“å°¾é€šå¸¸æ˜¯ _r ã€‚ä½†æ˜¯ä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°ä¼šç»™ç¨‹åºå‘˜å¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è‡ªåŠ¨æ›´æ”¹ä¸ºçº¿ç¨‹å®‰å…¨å‡½æ•°è°ƒç”¨ã€‚</p><blockquote><p>å£°æ˜å¤´æ–‡ä»¶å‰å®šä¹‰ <a href=https://stackoverflow.com/questions/2601753/what-is-the-reentrant-flag target=_blank rel=noopener>_REENTRANT</a> å®ã€‚</p></blockquote><p>ä¹Ÿæ— éœ€ç‰¹æ„æ›´æ”¹æºä»£ç ï¼Œå¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™æŒ‡å®šç¼–è¯‘å‚æ•°æ¥å®šä¹‰å®ã€‚<br>gcc -D_REENTRANT mythread.c -o mthread -lpthread</p><h4 id=å·¥ä½œworkerçº¿ç¨‹æ¨¡å‹><a href=#å·¥ä½œworkerçº¿ç¨‹æ¨¡å‹ class=anchor-link>#</a>å·¥ä½œï¼ˆWorkerï¼‰çº¿ç¨‹æ¨¡å‹</h4><p>è®¡ç®—ä» 1 åˆ° 10 çš„å’Œï¼Œä½†å¹¶ä¸æ˜¯é€šè¿‡ main å‡½æ•°è¿›è¡Œè¿ç®—ï¼Œè€Œæ˜¯åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹è®¡ç®— 1 åˆ° 5 çš„å’Œï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è®¡ç®— 6 åˆ° 10 çš„å’Œï¼Œmain å‡½æ•°<strong>åªè´Ÿè´£è¾“å‡ºè¿ç®—ç»“æœ</strong>ã€‚è¿™ç§æ–¹å¼çš„çº¿ç¨‹æ¨¡å‹ç§°ä¸ºã€Œå·¥ä½œçº¿ç¨‹ã€ã€‚æ˜¾ç¤ºè¯¥ç¨‹åºçš„æ‰§è¡Œæµç¨‹å›¾ï¼š<br><img src=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-20.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 alt=å›¾ç‰‡.png></p><h3 id=çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº><a href=#çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº class=anchor-link>#</a>çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº</h3><p>è¿™ç§æ–¹å¼å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼š</p><blockquote><p>2 ä¸ªçº¿ç¨‹æ­£åœ¨åŒæ—¶è®¿é—®å…¨å±€å˜é‡ num</p></blockquote><p>ä»»ä½•å†…å­˜ç©ºé—´ï¼Œåªè¦è¢«åŒæ—¶è®¿é—®ï¼Œéƒ½æœ‰å¯èƒ½å‘ç”Ÿé—®é¢˜ã€‚<br>å› æ­¤ï¼Œçº¿ç¨‹è®¿é—®å˜é‡ num æ—¶åº”è¯¥é˜»æ­¢å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œç›´åˆ°çº¿ç¨‹ 1 è¿ç®—å®Œæˆã€‚è¿™å°±æ˜¯åŒæ­¥ï¼ˆSynchronizationï¼‰</p><h4 id=ä¸´ç•ŒåŒºä½ç½®><a href=#ä¸´ç•ŒåŒºä½ç½® class=anchor-link>#</a>ä¸´ç•ŒåŒºä½ç½®</h4><p>å‡½æ•°å†…åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹æ“ä½œ<strong>åŒä¸€å˜é‡</strong>æ—¶å¼•å‘é—®é¢˜çš„å¤šæ¡è¯­å¥æ„æˆçš„ä»£ç å—</p><h3 id=çº¿ç¨‹åŒæ­¥><a href=#çº¿ç¨‹åŒæ­¥ class=anchor-link>#</a>çº¿ç¨‹åŒæ­¥</h3><p>çº¿ç¨‹åŒæ­¥ç”¨äºè§£å†³çº¿ç¨‹è®¿é—®é¡ºåºå¼•å‘çš„é—®é¢˜ã€‚éœ€è¦åŒæ­¥çš„æƒ…å†µå¯ä»¥ä»å¦‚ä¸‹ä¸¤æ–¹é¢è€ƒè™‘ã€‚</p><ul><li><strong>åŒæ—¶è®¿é—®</strong>åŒä¸€å†…å­˜ç©ºé—´æ—¶å‘ç”Ÿçš„æƒ…å†µ</li><li>éœ€è¦æŒ‡å®šè®¿é—®åŒä¸€å†…å­˜ç©ºé—´çš„<strong>çº¿ç¨‹é¡ºåº</strong>çš„æƒ…å†µ</li></ul><h4 id=äº’æ–¥é‡><a href=#äº’æ–¥é‡ class=anchor-link>#</a>äº’æ–¥é‡</h4><p>äº’æ–¥é”ï¼ˆè‹±è¯­ï¼šè‹±è¯­ï¼šMutual exclusionï¼Œç¼©å†™ Mutexï¼‰æ˜¯ä¸€ç§ç”¨äºå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé˜²æ­¢ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹åŒä¸€å…¬å…±èµ„æºï¼ˆæ¯”å¦‚å…¨å±€å˜é‡ï¼‰è¿›è¡Œè¯»å†™çš„æœºåˆ¶ã€‚<br>ä¸‹é¢æ˜¯äº’æ–¥é‡çš„<strong>åˆ›å»ºåŠé”€æ¯</strong>å‡½æ•°</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>pthread_mutex_init</span><span class=p>(</span><span class=n>pthread_mutex_t</span> <span class=o>*</span><span class=n>mutex</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=k>const</span> <span class=n>pthread_mutexattr_t</span> <span class=o>*</span><span class=n>attr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>pthread_mutex_destroy</span><span class=p>(</span><span class=n>pthread_mutex_t</span> <span class=o>*</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼
</span></span></span><span class=line><span class=cl><span class=cm>mutex : åˆ›å»ºäº’æ–¥é‡æ—¶ä¼ é€’ä¿å­˜äº’æ–¥é‡çš„å˜é‡åœ°å€å€¼ï¼Œé”€æ¯æ—¶ä¼ é€’éœ€è¦é”€æ¯çš„äº’æ–¥é‡åœ°å€
</span></span></span><span class=line><span class=cl><span class=cm>attr : ä¼ é€’å³å°†åˆ›å»ºçš„äº’æ–¥é‡å±æ€§ï¼Œæ²¡æœ‰ç‰¹åˆ«éœ€è¦æŒ‡å®šçš„å±æ€§æ—¶ä¼ é€’ NULL
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä»ä¸Šè¿°å‡½æ•°å£°æ˜ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†åˆ›å»ºç›¸å½“äºé”ç³»ç»Ÿçš„äº’æ–¥é‡ï¼Œéœ€è¦å£°æ˜å¦‚ä¸‹ pthread_mutex_t å‹å˜é‡ï¼š</p><blockquote><p>pthread_mutex_t mutex</p></blockquote><p>è¯¥å˜é‡çš„åœ°å€å€¼ä¼ é€’ç»™ pthread_mutex_init å‡½æ•°ï¼Œç”¨æ¥ä¿å­˜æ“ä½œç³»ç»Ÿåˆ›å»ºçš„äº’æ–¥é‡ï¼ˆé”ç³»ç»Ÿï¼‰ã€‚è°ƒç”¨ pthread_mutex_destroy å‡½æ•°æ—¶åŒæ ·éœ€è¦è¯¥ä¿¡æ¯ã€‚å¦‚æœä¸éœ€è¦é…ç½®ç‰¹æ®Šçš„äº’æ–¥é‡å±æ€§ï¼Œåˆ™å‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ NULL æ—¶ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ PTHREAD_MUTEX_INITIALIZER è¿›è¡Œå®åˆå§‹åŒ–ï¼š</p><blockquote><p>pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;</p></blockquote><p>æ¨èå°½å¯èƒ½çš„ä½¿ç”¨ pthread_mutex_init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œå› ä¸ºé€šè¿‡å®è¿›è¡Œåˆå§‹åŒ–æ—¶å¾ˆéš¾å‘ç°å‘ç”Ÿçš„é”™è¯¯ã€‚<br>ä¸‹é¢æ˜¯åˆ©ç”¨äº’æ–¥é‡<strong>é”ä½æˆ–é‡Šæ”¾</strong>ä¸´ç•ŒåŒºæ—¶ä½¿ç”¨çš„å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>pthread_mutex_lock</span><span class=p>(</span><span class=n>pthread_mutex_t</span> <span class=o>*</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>pthread_mutex_unlock</span><span class=p>(</span><span class=n>pthread_mutex_t</span> <span class=o>*</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//ä¸´ç•ŒåŒºå¼€å§‹
</span></span></span><span class=line><span class=cl><span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1>//ä¸´ç•ŒåŒºç»“æŸ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>  <span class=err>#</span> <span class=err>ä¸è§£é”ä¼šå‡ºç°</span> <span class=err>æ­»é”</span> <span class=err>æƒ…å†µ</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä½¿ç”¨mutexæ³¨æ„</p><blockquote><p>æœ€å¤§é™åº¦å‡å°‘äº’æ–¥é‡ lock unlock å‡½æ•°çš„<strong>è°ƒç”¨</strong>æ¬¡æ•°ï¼Œå°½é‡ä¸è¦åœ¨forä¸­åŠ é”</p></blockquote><h4 id=ä¿¡å·é‡><a href=#ä¿¡å·é‡ class=anchor-link>#</a>ä¿¡å·é‡</h4><p>ä¿¡å·é‡ï¼ˆè‹±è¯­ï¼šSemaphoreï¼‰åˆç§°ä¸ºä¿¡å·æ ‡ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥å¯¹è±¡ï¼Œç”¨äºä¿æŒåœ¨0è‡³æŒ‡å®šæœ€å¤§å€¼ä¹‹é—´çš„ä¸€ä¸ªè®¡æ•°å€¼ã€‚å½“çº¿ç¨‹å®Œæˆä¸€æ¬¡å¯¹è¯¥semaphoreå¯¹è±¡çš„<strong>ç­‰å¾…ï¼ˆwaitï¼‰æ—¶ï¼Œè¯¥è®¡æ•°å€¼å‡ä¸€</strong>ï¼›å½“çº¿ç¨‹å®Œæˆä¸€æ¬¡å¯¹semaphoreå¯¹è±¡çš„<strong>é‡Šæ”¾ï¼ˆreleaseï¼‰æ—¶ï¼Œè®¡æ•°å€¼åŠ ä¸€</strong>ã€‚å½“è®¡æ•°å€¼ä¸º0ï¼Œåˆ™çº¿ç¨‹ç­‰å¾…è¯¥semaphoreå¯¹è±¡ä¸å†èƒ½æˆåŠŸï¼Œç›´è‡³è¯¥semaphoreå¯¹è±¡å˜æˆsignaledçŠ¶æ€ã€‚semaphoreå¯¹è±¡çš„è®¡æ•°å€¼å¤§äº0ï¼Œä¸ºsignaledçŠ¶æ€ï¼›è®¡æ•°å€¼ç­‰äº0ï¼Œä¸ºnonsignaledçŠ¶æ€.<br>semaphoreå¯¹è±¡é€‚ç”¨äºæ§åˆ¶ä¸€ä¸ªä»…æ”¯æŒæœ‰é™ä¸ªç”¨æˆ·çš„å…±äº«èµ„æºï¼Œæ˜¯ä¸€ç§ä¸éœ€è¦ä½¿ç”¨å¿™ç¢Œç­‰å¾…ï¼ˆbusy waitingï¼‰çš„æ–¹æ³•ã€‚<br>ä¸‹é¢æ˜¯ä¿¡å·é‡çš„åˆ›å»ºåŠé”€æ¯æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;semaphore.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>sem_init</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>,</span> <span class=kt>int</span> <span class=n>pshared</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sem_destroy</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼
</span></span></span><span class=line><span class=cl><span class=cm>sem : åˆ›å»ºä¿¡å·é‡æ—¶ä¿å­˜ä¿¡å·é‡çš„å˜é‡åœ°å€å€¼ï¼Œé”€æ¯æ—¶ä¼ é€’éœ€è¦é”€æ¯çš„ä¿¡å·é‡å˜é‡åœ°å€å€¼
</span></span></span><span class=line><span class=cl><span class=cm>pshared : ä¼ é€’å…¶ä»–å€¼æ—¶ï¼Œåˆ›å»ºå¯ç”±å¤šä¸ªç»§æ‰¿å…±äº«çš„ä¿¡å·é‡ï¼›ä¼ é€’ 0 æ—¶ï¼Œåˆ›å»ºåªå…è®¸ 1 ä¸ªè¿›ç¨‹å†…éƒ¨ä½¿ç”¨çš„ä¿¡å·é‡ã€‚éœ€è¦å®ŒæˆåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹åŒæ­¥ï¼Œæ•…ä¸º0
</span></span></span><span class=line><span class=cl><span class=cm>value : æŒ‡å®šåˆ›å»ºä¿¡å·é‡çš„åˆå§‹å€¼
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>ä¿¡å·é‡ä¸­ç›¸å½“äºäº’æ–¥é‡ lock unlock çš„å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;semaphore.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>sem_post</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sem_wait</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼
</span></span></span><span class=line><span class=cl><span class=cm>sem : ä¼ é€’ä¿å­˜ä¿¡å·é‡è¯»å–å€¼çš„å˜é‡åœ°å€å€¼ï¼Œä¼ é€’ç»™ sem_post çš„ä¿¡å·é‡å¢1ï¼Œä¼ é€’ç»™ sem_wait æ—¶ä¿¡å·é‡å‡ä¸€
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>è°ƒç”¨ sem_init å‡½æ•°æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†åˆ›å»ºä¿¡å·é‡å¯¹è±¡ï¼Œæ­¤å¯¹è±¡ä¸­è®°å½•è¿™ã€Œä¿¡å·é‡å€¼ã€ï¼ˆSemaphore Valueï¼‰æ•´æ•°ã€‚è¯¥å€¼åœ¨è°ƒç”¨ sem_post å‡½æ•°æ—¶å¢åŠ  1 ï¼Œè°ƒç”¨ wait_wait å‡½æ•°æ—¶å‡ä¸€ã€‚ä½†ä¿¡å·é‡çš„å€¼ä¸èƒ½å°äº 0 ï¼Œå› æ­¤ï¼Œåœ¨ä¿¡å·é‡ä¸º 0 çš„æƒ…å†µä¸‹è°ƒç”¨ sem_wait å‡½æ•°æ—¶ï¼Œè°ƒç”¨çš„çº¿ç¨‹å°†è¿›å…¥é˜»å¡çŠ¶æ€ï¼ˆå› ä¸ºå‡½æ•°æœªè¿”å›ï¼‰ã€‚å½“ç„¶ï¼Œæ­¤æ—¶å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨ sem_post å‡½æ•°ï¼Œä¿¡å·é‡çš„å€¼å°†å˜ä¸º 1 ï¼Œè€ŒåŸæœ¬é˜»å¡çš„çº¿ç¨‹å¯ä»¥å°†è¯¥ä¿¡å·é‡æ–°å‡ä¸º 0 å¹¶è·³å‡ºé˜»å¡çŠ¶æ€ã€‚<br>äºŒè¿›åˆ¶ä¿¡å·é‡çš„ä½¿ç”¨ï¼š</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem</span><span class=p>);</span><span class=c1>//ä¿¡å·é‡å˜ä¸º0...
</span></span></span><span class=line><span class=cl><span class=c1>// ä¸´ç•ŒåŒºçš„å¼€å§‹
</span></span></span><span class=line><span class=cl><span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1>//ä¸´ç•ŒåŒºçš„ç»“æŸ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem</span><span class=p>);</span><span class=c1>//ä¿¡å·é‡å˜ä¸º1...
</span></span></span></code></pre></td></tr></table></div></div></div><h3 id=çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°><a href=#çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç° class=anchor-link>#</a>çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</h3><h4 id=é”€æ¯çº¿ç¨‹çš„-3-ç§æ–¹æ³•><a href=#é”€æ¯çº¿ç¨‹çš„-3-ç§æ–¹æ³• class=anchor-link>#</a>é”€æ¯çº¿ç¨‹çš„ 3 ç§æ–¹æ³•</h4><ul><li>è°ƒç”¨ pthread_join å‡½æ•°</li></ul><p>è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä¸ä»…ä¼šç­‰å¾…çº¿ç¨‹ç»ˆæ­¢ï¼Œè¿˜ä¼šå¼•å¯¼çº¿ç¨‹é”€æ¯ã€‚ä½†è¯¥å‡½æ•°çš„é—®é¢˜æ˜¯ï¼Œçº¿ç¨‹ç»ˆæ­¢å‰ï¼Œ<strong>è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹</strong>å°†è¿›å…¥é˜»å¡çŠ¶æ€ã€‚å› æ­¤ï¼Œé€šè¿‡å¦‚ä¸‹å‡½æ•°è°ƒç”¨å¼•å¯¼çº¿ç¨‹é”€æ¯ã€‚</p><ul><li>è°ƒç”¨ pthread_detach å‡½æ•°</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>pthread_detach</span><span class=p>(</span><span class=n>pthread_t</span> <span class=n>th</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼
</span></span></span><span class=line><span class=cl><span class=cm>thread : ç»ˆæ­¢çš„åŒæ—¶éœ€è¦é”€æ¯çš„çº¿ç¨‹ ID
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div></div><p>è°ƒç”¨ä¸Šè¿°å‡½æ•°ä¸ä¼šå¼•èµ·çº¿ç¨‹ç»ˆæ­¢æˆ–è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡è¯¥å‡½æ•°å¼•å¯¼é”€æ¯çº¿ç¨‹åˆ›å»ºçš„å†…å­˜ç©ºé—´ã€‚è°ƒç”¨è¯¥å‡½æ•°åä¸èƒ½å†é’ˆå¯¹ç›¸åº”çº¿ç¨‹è°ƒç”¨ pthread_join å‡½æ•°ã€‚</p><h4 id=å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°><a href=#å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç° class=anchor-link>#</a>å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</h4><p>ä¸‹é¢æ˜¯å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥äº¤æ¢ä¿¡æ¯çš„ç®€å•èŠå¤©ç¨‹åºã€‚</p><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/chat_server.c target=_blank rel=noopener>chat_server.c</a></li><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/chat_clnt.c target=_blank rel=noopener>chat_clnt.c</a></li></ul><p>ä¸Šé¢çš„æœåŠ¡ç«¯ç¤ºä¾‹ä¸­ï¼Œéœ€è¦æŒæ¡ä¸´ç•ŒåŒºçš„æ„æˆï¼Œè®¿é—®å…¨å±€å˜é‡ clnt_cnt å’Œæ•°ç»„ clnt_socks çš„ä»£ç å°†æ„æˆä¸´ç•ŒåŒºï¼Œæ·»åŠ å’Œåˆ é™¤å®¢æˆ·ç«¯æ—¶ï¼Œå˜é‡ clnt_cnt å’Œæ•°ç»„ clnt_socks å°†åŒæ—¶å‘ç”Ÿå˜åŒ–ã€‚å› æ­¤ä¸‹åˆ—æƒ…å½¢ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œä»è€Œå¼•å‘é”™è¯¯ï¼š</p><ul><li>çº¿ç¨‹ A ä»æ•°ç»„ clnt_socks ä¸­åˆ é™¤å¥—æ¥å­—ä¿¡æ¯ï¼ŒåŒæ—¶çº¿ç¨‹ B è¯»å– clnt_cnt å˜é‡</li><li>çº¿ç¨‹ A è¯»å–å˜é‡ clnt_cnt ï¼ŒåŒæ—¶çº¿ç¨‹ B å°†å¥—æ¥å­—ä¿¡æ¯æ·»åŠ åˆ° clnt_socks æ•°ç»„</li></ul><h2 id=åˆ¶ä½œ-http-æœåŠ¡å™¨ç«¯><a href=#åˆ¶ä½œ-http-æœåŠ¡å™¨ç«¯ class=anchor-link>#</a>åˆ¶ä½œ HTTP æœåŠ¡å™¨ç«¯</h2><h3 id=http-æ¦‚è¦><a href=#http-æ¦‚è¦ class=anchor-link>#</a>HTTP æ¦‚è¦</h3><p>æœ¬ç« å°†ç¼–å†™ HTTPï¼ˆHyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰æœåŠ¡å™¨ç«¯ï¼Œå³ Web æœåŠ¡å™¨ç«¯ã€‚</p><h4 id=ç†è§£-web-æœåŠ¡å™¨ç«¯><a href=#ç†è§£-web-æœåŠ¡å™¨ç«¯ class=anchor-link>#</a>ç†è§£ Web æœåŠ¡å™¨ç«¯</h4><p>webæœåŠ¡å™¨ç«¯å°±æ˜¯è¦åŸºäº HTTP åè®®ï¼Œå°†ç½‘é¡µå¯¹åº”æ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„æœåŠ¡å™¨ç«¯ã€‚</p><h4 id=http><a href=#http class=anchor-link>#</a>HTTP</h4><p>æ— çŠ¶æ€çš„ Stateless åè®®<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-21.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-21.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=XcoFX&amp;originHeight=374&amp;originWidth=309&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡å™¨ç«¯ç›¸åº”å®¢æˆ·ç«¯è¯·æ±‚åç«‹å³æ–­å¼€è¿æ¥ã€‚æ¢è¨€ä¹‹ï¼ŒæœåŠ¡å™¨ç«¯ä¸ä¼šç»´æŒå®¢æˆ·ç«¯çŠ¶æ€ã€‚å³ä½¿åŒä¸€å®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿæ— æ³•è¾¨è®¤å‡ºæ˜¯åŸå…ˆé‚£ä¸ªï¼Œè€Œä¼šä»¥ç›¸åŒæ–¹å¼å¤„ç†æ–°è¯·æ±‚ã€‚å› æ­¤ï¼ŒHTTP åˆç§°ã€Œæ— çŠ¶æ€çš„ Stateless åè®®ã€</p><h4 id=è¯·æ±‚æ¶ˆæ¯request-messageçš„ç»“æ„><a href=#è¯·æ±‚æ¶ˆæ¯request-messageçš„ç»“æ„ class=anchor-link>#</a>è¯·æ±‚æ¶ˆæ¯ï¼ˆRequest Messageï¼‰çš„ç»“æ„</h4><p>ä¸‹é¢æ˜¯<strong>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯</strong>å‘èµ·è¯·æ±‚æ¶ˆæ¯çš„ç»“æ„ï¼š<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-22.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-22.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=CMVff&amp;originHeight=292&amp;originWidth=391&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯·æ±‚æ¶ˆæ¯å¯ä»¥åˆ†ä¸º<strong>è¯·æ±‚å¤´ã€æ¶ˆæ¯å¤´ã€æ¶ˆæ¯ä½“</strong> 3 ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­ï¼Œè¯·æ±‚è¡Œå«æœ‰è¯·æ±‚æ–¹å¼ï¼ˆè¯·æ±‚ç›®çš„ï¼‰ä¿¡æ¯ã€‚å…¸å‹çš„è¯·æ±‚æ–¹å¼æœ‰ GET å’Œ POST ï¼ŒGET ä¸»è¦ç”¨äºè¯·æ±‚æ•°æ®ï¼ŒPOST ä¸»è¦ç”¨äºä¼ è¾“æ•°æ®ã€‚ä¸ºäº†é™ä½å¤æ‚åº¦ï¼Œæˆ‘ä»¬å®ç°åªèƒ½å“åº” GET è¯·æ±‚çš„ Web æœåŠ¡å™¨ç«¯ï¼Œä¸‹é¢è§£é‡Šå›¾ä¸­çš„è¯·æ±‚è¡Œä¿¡æ¯ã€‚å…¶ä¸­ã€ŒGET/index.html HTTP/1.1ã€ å…·æœ‰å¦‚ä¸‹å«ä¹‰ï¼š<br>è¯·æ±‚ï¼ˆGETï¼‰index.html æ–‡ä»¶ï¼Œé€šå¸¸ä»¥ 1.1 ç‰ˆæœ¬çš„ HTTP åè®®è¿›è¡Œé€šä¿¡ã€‚<br><strong>è¯·æ±‚è¡Œåªèƒ½é€šè¿‡ 1 è¡Œï¼ˆlineï¼‰å‘é€</strong>ï¼Œå› æ­¤ï¼ŒæœåŠ¡å™¨ç«¯å¾ˆå®¹æ˜“ä» HTTP è¯·æ±‚ä¸­æå–ç¬¬ä¸€è¡Œï¼Œå¹¶åˆ†åˆ«åˆ†æè¯·æ±‚è¡Œä¸­çš„ä¿¡æ¯ã€‚<br>è¯·æ±‚è¡Œä¸‹é¢çš„<strong>æ¶ˆæ¯å¤´ä¸­åŒ…å«å‘é€è¯·æ±‚çš„æµè§ˆå™¨ä¿¡æ¯ã€ç”¨æˆ·è®¤è¯ä¿¡æ¯ç­‰å…³äº HTTP æ¶ˆæ¯çš„é™„åŠ ä¿¡æ¯</strong>ã€‚æœ€åçš„<strong>æ¶ˆæ¯ä½“ä¸­è£…æœ‰å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¼ è¾“çš„æ•°æ®</strong>ï¼Œä¸ºäº†è£…å…¥æ•°æ®ï¼Œéœ€è¦ä»¥ POST æ–¹å¼å‘é€è¯·æ±‚ã€‚ä½†æ˜¯æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç° GET æ–¹å¼çš„æœåŠ¡å™¨ç«¯ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥è¿™éƒ¨åˆ†å†…å®¹ã€‚å¦å¤–ï¼Œæ¶ˆæ¯ä½“å’Œæ¶ˆæ¯å¤´ä¸ä¹‹é—´ä»¥ç©ºè¡Œéš”å¼€ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿè¾¹ç•Œé—®é¢˜ã€‚</p><h4 id=2414-å“åº”æ¶ˆæ¯response-messageçš„ç»“æ„><a href=#2414-å“åº”æ¶ˆæ¯response-messageçš„ç»“æ„ class=anchor-link>#</a>24.1.4 å“åº”æ¶ˆæ¯ï¼ˆResponse Messageï¼‰çš„ç»“æ„</h4><p>ä¸‹é¢æ˜¯ Web <strong>æœåŠ¡å™¨ç«¯å‘å®¢æˆ·ç«¯</strong>ä¼ é€’çš„å“åº”ä¿¡æ¯çš„ç»“æ„ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯¥å“åº”æ¶ˆæ¯ç”±çŠ¶æ€è¡Œã€å¤´ä¿¡æ¯ã€æ¶ˆæ¯ä½“ç­‰ 3 ä¸ªéƒ¨åˆ†ç»„æˆã€‚çŠ¶æ€è¡Œä¸­æœ‰å…³äºè¯·æ±‚çš„çŠ¶æ€ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸è¯·æ±‚æ¶ˆæ¯ç›¸æ¯”æœ€ä¸ºæ˜¾è‘—åœ°åŒºåˆ«ã€‚<br><a href=https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-23.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5 target=_blank rel=noopener><img src="https://pic.keepjolly.com/halo/blog/2023/08/20230813224506-23.png?imageMogr2/format/webp%7C?watermark/3/type/3/text/a2VlcGpvbGx5#from=url&amp;id=uKMdm&amp;originHeight=287&amp;originWidth=387&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt></a><br>ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²<strong>çŠ¶æ€è¡Œä¸­å«æœ‰å…³äºå®¢æˆ·ç«¯è¯·æ±‚çš„å¤„ç†ç»“æœ</strong>ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ index.html æ–‡ä»¶æ—¶ï¼Œè¡¨ç¤º index.html æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€æœåŠ¡ç«¯æ˜¯å¦å‘ç”Ÿé—®é¢˜è€Œæ— æ³•å“åº”ç­‰ä¸åŒæƒ…å†µçš„ä¿¡æ¯å†™å…¥çŠ¶æ€è¡Œã€‚å›¾ä¸­çš„ã€ŒHTTP/1.1 200 OKã€å…·æœ‰å¦‚ä¸‹å«ä¹‰ï¼š</p><ul><li>200 OK : æˆåŠŸå¤„ç†äº†è¯·æ±‚!</li><li>404 Not Found : è¯·æ±‚çš„æ–‡ä»¶ä¸å­˜åœ¨!</li><li>400 Bad Request : è¯·æ±‚æ–¹å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼</li></ul><p><strong>æ¶ˆæ¯å¤´ä¸­å«æœ‰ä¼ è¾“çš„æ•°æ®ç±»å‹å’Œé•¿åº¦ç­‰ä¿¡æ¯</strong>ã€‚å›¾ä¸­çš„æ¶ˆæ¯å¤´å«æœ‰å¦‚ä¸‹ä¿¡æ¯ï¼š<br>æœåŠ¡ç«¯åä¸º SimpleWebServer ï¼Œä¼ è¾“çš„æ•°æ®ç±»å‹ä¸º text/htmlã€‚æ•°æ®é•¿åº¦ä¸è¶…è¿‡ 2048 ä¸ªå­—èŠ‚ã€‚<br>æœ€åæ’å…¥ä¸€ä¸ªç©ºè¡Œåï¼Œé€šè¿‡æ¶ˆæ¯ä½“<strong>å‘é€å®¢æˆ·ç«¯è¯·æ±‚çš„æ–‡ä»¶æ•°æ®</strong>ã€‚ä»¥ä¸Šå°±æ˜¯å®ç° Web æœåŠ¡ç«¯è¿‡ç¨‹ä¸­å¿…è¦çš„ HTTP åè®®ã€‚</p></div></article><footer class=minimal-footer><div class=post-tag><a href=/tags/tcp/ rel=tag class=post-tag-link>#tcp</a> <a href=/tags/c-/ rel=tag class=post-tag-link>#c</a> <a href=/tags/network/ rel=tag class=post-tag-link>#network</a></div><div class=post-category><a href=/posts/ class="post-category-link active">posts</a> |</div></footer></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div></div><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css><script>if(typeof renderMathInElement=="undefined"){const e=e=>{const t=document.createElement("script");t.defer=!0,t.crossOrigin="anonymous",Object.keys(e).forEach(n=>{t[n]=e[n]}),document.body.appendChild(t)};e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js",onload:()=>{e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/mhchem.min.js",onload:()=>{e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js",onload:()=>{renderKaTex()}})}})}})}else renderKaTex();function renderKaTex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>let imgNodes=document.querySelectorAll("div.post-body img");imgNodes=Array.from(imgNodes).filter(e=>e.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script></body></html>